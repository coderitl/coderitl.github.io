<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>SpringSecurity | coder-itl</title>
  <meta name="author" content="coder-itl">
  <meta name="copyright" content="coder-itl">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="SpringSecurity简介 简介 ​	SpringSecurity是一个功能强大且高度可定制的身份验证和访问控制框架。SpringSecurity致力于为Java应用程序提供身份验证和授权的能力。像所有Spring项目一样，SpringSecurity的真正强大之处在于它可以轻松扩展以满足定制需求的能力	   核心功能  用户认证(Authentication): 验证某个用户是否为系统">
  <meta property="og:type" content="article">
  <meta property="og:title" content="SpringSecurity">
  <meta property="og:url" content="https://coderitl.github.io/2022/10/15/52913.html">
  <meta property="og:site_name" content="coder-itl">
  <meta property="og:description" content="SpringSecurity简介 简介 ​	SpringSecurity是一个功能强大且高度可定制的身份验证和访问控制框架。SpringSecurity致力于为Java应用程序提供身份验证和授权的能力。像所有Spring项目一样，SpringSecurity的真正强大之处在于它可以轻松扩展以满足定制需求的能力	   核心功能  用户认证(Authentication): 验证某个用户是否为系统">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:image" content="https://img-blog.csdnimg.cn/0b5998dfeeb34ef2a9bcb0072018a277.png">
  <meta property="article:published_time" content="2022-10-15T07:20:24.000Z">
  <meta property="article:modified_time" content="2023-06-22T11:51:59.474Z">
  <meta property="article:author" content="coder-itl">
  <meta property="article:tag" content="coder-itl,Java,HTML+CSS,Hexo,MYSQL">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image" content="https://img-blog.csdnimg.cn/0b5998dfeeb34ef2a9bcb0072018a277.png">
  <link rel="shortcut icon" href="https://img-blog.csdnimg.cn/f44f454681b440f3a8ae5f086d3c07d9.png">
  <link rel="canonical" href="https://coderitl.github.io/2022/10/15/52913.html">
  <link rel="preconnect" href="//cdn.jsdelivr.net">
  <link rel="preconnect" href="//busuanzi.ibruce.info">
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'">
  <script>
    const GLOBAL_CONFIG = {
      root: '/',
      algolia: undefined,
      localSearch:
      {
        "path": "/search.xml",
        "preload": false,
        "languages":
        {
          "hits_empty": "找不到您查询的内容：${query}"
        }
      },
      translate: undefined,
      noticeOutdate: undefined,
      highlight:
      {
        "plugin": "highlighjs",
        "highlightCopy": true,
        "highlightLang": false,
        "highlightHeightLimit": false
      },
      copy:
      {
        success: '复制成功',
        error: '复制错误',
        noSupport: '浏览器不支持'
      },
      relativeDate:
      {
        homepage: false,
        post: false
      },
      runtime: '',
      date_suffix:
      {
        just: '刚刚',
        min: '分钟前',
        hour: '小时前',
        day: '天前',
        month: '个月前'
      },
      copyright: undefined,
      lightbox: 'fancybox',
      Snackbar: undefined,
      source:
      {
        justifiedGallery:
        {
          js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
          css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
        }
      },
      isPhotoFigcaption: false,
      islazyload: true,
      isAnchor: false,
      percent:
      {
        toc: true,
        rightside: false,
      }
    }

  </script>
  <script id="config-diff">
    var GLOBAL_CONFIG_SITE = {
      title: 'SpringSecurity',
      isPost: true,
      isHome: false,
      isHighlightShrink: false,
      isToc: true,
      postUpdate: '2023-06-22 19:51:59'
    }

  </script><noscript>
    <style type="text/css">
      #nav
      {
        opacity: 1
      }

      .justified-gallery img
      {
        opacity: 1
      }

      #recent-posts time,
      #post-meta time
      {
        display: inline !important
      }

    </style>
  </noscript>
  <script>
    (win =>
    {
      win.saveToLocal = {
        set: function setWithExpiry(key, value, ttl)
        {
          if (ttl === 0) return
          const now = new Date()
          const expiryDay = ttl * 86400000
          const item = {
            value: value,
            expiry: now.getTime() + expiryDay,
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
        get: function getWithExpiry(key)
        {
          const itemStr = localStorage.getItem(key)
          if (!itemStr)
          {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = new Date()
          if (now.getTime() > item.expiry)
          {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      win.getScript = url => new Promise((resolve, reject) =>
      {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function ()
        {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(script)
      })
      win.getCSS = url => new Promise((resolve, reject) =>
      {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        link.onload = () => resolve()
        link.onerror = () => reject()
        document.head.appendChild(link)
      })
      win.activateDarkMode = function ()
      {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null)
        {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function ()
      {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null)
        {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
      if (t === 'dark') activateDarkMode()
      else if (t === 'light') activateLightMode()
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined)
      {
        if (asideStatus === 'hide')
        {
          document.documentElement.classList.add('hide-aside')
        }
        else
        {
          document.documentElement.classList.remove('hide-aside')
        }
      }
      const detectApple = () =>
      {
        if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent))
        {
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)

  </script>
  <link rel="stylesheet" href="/css/modify.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/coderitl/FileJsDeliver@v1.1.12/css/gitcalendar.css" media="defer" onload="this.media='all'">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/coderitl/FileJsDeliver@v1.1.13/swiper/swiper.min.css" media="defer" onload="this.media='all'">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/coderitl/FileJsDeliver@v1.1.13/swiper/swiperstyle.css" media="defer" onload="this.media='all'">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/animate-css/animate.css@3.7.2/animate.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css" media="defer">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/coderitl/globalfont@v0.0.4/my.css">
  <link rel="stylesheet" href="/css/my.css">
  <meta name="referrer" content="no-referrer"><!-- hexo injector head_end start -->
  <style>
    body hanla:after
    {
      content: ' ';
      display: inline;
      font-family: inherit;
      font-size: 0.45em;
    }

    html code hanla,
    html pre hanla,
    html kbd hanla,
    html samp hanla,
    html ruby hanla,
    html .tag-list-item hanla
    {
      display: none;
    }

    html ol>hanla,
    html ul>hanla
    {
      display: none;
    }

  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css">
  <style>
    #recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags:before
    {
      content: "\A";
      white-space: pre;
    }

    #recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags>.article-meta__separator
    {
      display: none
    }

  </style>
  <link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'">
  <link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'">
  <script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end -->
  <meta name="generator" content="Hexo 5.4.2">
  <link rel="alternate" href="/atom.xml" title="coder-itl" type="application/atom+xml">
</head>

<body>
  <div id="loading-box">
    <div class="loading-left-bg"></div>
    <div class="loading-right-bg"></div>
    <div class="spinner-box">
      <div class="configure-border-1">
        <div class="configure-core"></div>
      </div>
      <div class="configure-border-2">
        <div class="configure-core"></div>
      </div>
      <div class="loading-word">加载中...</div>
    </div>
  </div>
  <script>
    const preloader = {
      endLoading: () =>
      {
        document.body.style.overflow = 'auto';
        document.getElementById('loading-box').classList.add("loaded")
      },
      initLoading: () =>
      {
        document.body.style.overflow = '';
        document.getElementById('loading-box').classList.remove("loaded")
      }
    }
    window.addEventListener('load', () =>
    {
      preloader.endLoading()
    })
    if (true)
    {
      document.addEventListener('pjax:send', () =>
      {
        preloader.initLoading()
      })
      document.addEventListener('pjax:complete', () =>
      {
        preloader.endLoading()
      })
    }

  </script>
  <div id="web_bg"></div>
  <div id="sidebar">
    <div id="menu-mask"></div>
    <div id="sidebar-menus">
      <div class="avatar-img is-center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://i.328888.xyz/2023/03/19/MJUXa.jpeg" onerror="onerror=null;src='https://i.328888.xyz/2023/03/20/P3kfC.gif'" alt="avatar"></div>
      <div class="sidebar-site-data site-data is-center"><a href="/archives/">
          <div class="headline">
            <hanla></hanla>文章<hanla></hanla>
          </div>
          <div class="length-num">119</div>
        </a><a href="/tags/">
          <div class="headline">
            <hanla></hanla>标签<hanla></hanla>
          </div>
          <div class="length-num">21</div>
        </a><a href="/categories/">
          <div class="headline">
            <hanla></hanla>分类<hanla></hanla>
          </div>
          <div class="length-num">13</div>
        </a></div>
      <hr>
      <div class="menus_items">
        <div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div>
        <div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div>
        <div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div>
        <div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div>
        <div class="menus_item"><a class="site-page" href="/Timeline/"><i class="fa-fw fab fa-docker"></i><span> 日志</span></a></div>
        <div class="menus_item"><a class="site-page" href="/Java-%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/"><i class="fa-fw fas fa-link"></i><span> 学习路线</span></a></div>
        <div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于<hanla></hanla></span></a></div>
      </div>
    </div>
  </div>
  <div class="post" id="body-wrap">
    <header class="post-bg" id="page-header" style="background-image: url('https://img-blog.csdnimg.cn/0b5998dfeeb34ef2a9bcb0072018a277.png')">
      <nav id="nav"><span id="blog-info"><a href="/" title="coder-itl"><span class="site-name">coder-itl</span></a></span>
        <div id="menus">
          <div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div>
          <div class="menus_items">
            <div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div>
            <div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div>
            <div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div>
            <div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div>
            <div class="menus_item"><a class="site-page" href="/Timeline/"><i class="fa-fw fab fa-docker"></i><span> 日志</span></a></div>
            <div class="menus_item"><a class="site-page" href="/Java-%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/"><i class="fa-fw fas fa-link"></i><span> 学习路线</span></a></div>
            <div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于<hanla></hanla></span></a></div>
          </div>
          <div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div>
        </div>
      </nav>
      <div id="post-info">
        <h1 class="post-title">SpringSecurity</h1>
        <div id="post-meta">
          <div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">
                <hanla></hanla>发表于<hanla></hanla>
              </span><time class="post-meta-date-created" datetime="2022-10-15T07:20:24.000Z" title="发表于 2022-10-15 15:20:24">2022-10-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于<hanla></hanla></span><time class="post-meta-date-updated" datetime="2023-06-22T11:51:59.474Z" title="更新于 2023-06-22 19:51:59">2023-06-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div>
          <div class="meta-secondline"><span class="post-meta-separator">|</span><span id="" data-flag-title="SpringSecurity"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div>
        </div>
      </div>
    </header>
    <main class="layout" id="content-inner">
      <div id="post"><div class="top-img" style="background-image: url('https://img-blog.csdnimg.cn/0b5998dfeeb34ef2a9bcb0072018a277.png');"></div>
        <article class="post-content" id="article-container">
          <meta name="referrer" content="no-referrer">
          <h3 id="SpringSecurity"><a href="#SpringSecurity" class="headerlink" title="SpringSecurity"></a>SpringSecurity</h3>
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>
            <hanla></hanla>简介
          </h4>
          <ul>
            <li>
              <p>简介</p>
              <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
                <p>​ <code>SpringSecurity</code>
                  <hanla></hanla>是一个功能强大且高度可定制的身份验证和访问控制框架。<code>SpringSecurity</code>
                  <hanla></hanla>致力于为<hanla></hanla><code>Java</code>
                  <hanla></hanla>应用程序提供身份验证和授权的能力。像所有<hanla></hanla><code>Spring</code>
                  <hanla></hanla>项目一样，<code>SpringSecurity</code>
                  <hanla></hanla>的真正强大之处在于它可以轻松扩展以满足定制需求的能力
                </p>
              </div>
            </li>
            <li>
              <p>核心功能</p>
              <ul>
                <li>用户认证<hanla></hanla>(<code>Authentication</code>): 验证某个用户是否为系统中的合法主体，也就是说用户能否访问该系统。用户认证一般要求用户提供用户名和密码。系统通过校验用户名和密码来完成认证过程</li>
                <li>用户授权<hanla></hanla>(<code>Authorization</code>): 验证某个用户是否具有权限操作执行某个操作。在一个系统中，不同用户所有的权限是不同的。比如对一个文件来说，有的用户只能进行读取，有的用户既能读取,<hanla></hanla>又能修改。一般来说，系统会为不同的用户分配不同的角色，而每个角色对应一系列的权限</li>
              </ul>
            </li>
          </ul>
          <h4 id="创建起步初识项目"><a href="#创建起步初识项目" class="headerlink" title="创建起步初识项目"></a>创建起步初识项目</h4>
          <ul>
            <li>
              <p>添加依赖</p>
              <figure class="highlight xml">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>版本信息</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">版本确定</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/3040e142492f43afac0c228bf5160210.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>创建控制器</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello SpringSecurity"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>启动访问</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">添加<hanla></hanla><code>security</code>,<hanla></hanla>访问会出现如下页面</th>
                    <th align="center">用户名:<code>user</code>，密码来自于控制台</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/573f031eafaa4d86bf656c65d3c05f12.png"></td>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/26f8c9912ed74c2f8b997107ec435ebe.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>
          <h4 id="过滤器链"><a href="#过滤器链" class="headerlink" title="过滤器链"></a>过滤器链</h4>
          <ul>
            <li>
              <p>调式查看</p>
              <table>
                <thead>
                  <tr>
                    <th align="center"><code>客户端-&gt;<hanla></hanla>目标资源</code></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/109823416cb944f7b86f1f0bc9b31774.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>功能介绍</p>
              <ul>
                <li><code>WebAsyncManagerIntegrationFilter</code>: 将<hanla></hanla><code>SecurityContext</code>
                  <hanla></hanla>集成到<hanla></hanla><code>SpringMVC</code>
                  <hanla></hanla>中用于管理异步请求处理的<hanla></hanla><code>WebAsyncManager</code>
                  <hanla></hanla>中
                </li>
                <li><code>SecurityContextPersistenceFilter</code>: 在当前会话中填充<hanla></hanla><code>SecurityContext</code>,<code>SecurityContext</code>
                  <hanla></hanla>即<hanla></hanla><code>Security</code>
                  <hanla></hanla>的上下文对象，里面包含了当前用户的认证及权限信息等
                </li>
                <li><code>HeadWriteFilter</code>: 向请求的<hanla></hanla><code>Header</code>
                  <hanla></hanla>中添加信息
                </li>
                <li><code>LogoutFilter</code>:<hanla></hanla>匹配<hanla></hanla><code>URL</code>
                  <hanla></hanla>为<hanla></hanla><code>/logout</code>
                  <hanla></hanla>的请求，清除认证信息,<hanla></hanla>实现用户注销功能
                </li>
                <li><code>UsernamePasswordAuthenticationFilter</code>: 认证操作的过滤器,<hanla></hanla>用于匹配<hanla></hanla><code>URL</code>
                  <hanla></hanla>为<hanla></hanla><code>/login</code>
                  <hanla></hanla>的<hanla></hanla><code>POST</code>
                  <hanla></hanla>请求做拦截,<hanla></hanla>校验表单的用户名和密码
                </li>
                <li><code>RequestCacheAwareFilter</code>: 用于缓存<hanla></hanla><code>HttpServletRequest</code></li>
                <li><code>SecurityContextHolderAwareRequestFilter</code>: 用于封装<hanla></hanla><code>ServletRequest</code>,<hanla></hanla>让<hanla></hanla><code>ServletRequest</code>
                  <hanla></hanla>具备更多功能
                </li>
                <li><code>AnonymousAuthenticationFilter</code>: 对于未登录情况下的处理,<hanla></hanla>当<hanla></hanla><code>SecurityContextHolder</code>
                  <hanla></hanla>中认证信息为空,<hanla></hanla>则会创建一个匿名用户存入到<hanla></hanla><code>SecurityContextHolder</code>
                  <hanla></hanla>中
                </li>
                <li><code>SessionManagementFilter</code>: 限制统一用户开启多个会话</li>
                <li><code>ExceptionTranslationFilter</code>: 异常过滤器,<hanla></hanla>用来处理在认证授权过程中抛出的异常</li>
                <li><code>FilterSecurityInterceptor</code>: 获取授权信息，根据<hanla></hanla><code>SecurityContextHolder</code>
                  <hanla></hanla>中存储的用户信息判断用户是否有权限访问
                </li>
              </ul>
            </li>
            <li>
              <p>过滤器的加载过程</p>
              <blockquote>
                <p><code>SpringBoot</code>
                  <hanla></hanla>在整合<hanla></hanla><code>SpringSecurity</code>
                  <hanla></hanla>项目时会自动配置<hanla></hanla><code>DelegatingFilterProxy</code>
                  <hanla></hanla>过滤器,<hanla></hanla>若非<hanla></hanla><code>Springboot</code>
                  <hanla></hanla>工程、则需要手动配置该过滤器
                </p>
              </blockquote>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException {</span><br><span class="line">    <span class="type">Filter</span> <span class="variable">delegateToUse</span> <span class="operator">=</span> <span class="built_in">this</span>.delegate;</span><br><span class="line">    <span class="keyword">if</span> (delegateToUse == <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="built_in">this</span>.delegateMonitor) {</span><br><span class="line">            delegateToUse = <span class="built_in">this</span>.delegate;</span><br><span class="line">            <span class="keyword">if</span> (delegateToUse == <span class="literal">null</span>) {</span><br><span class="line">                <span class="type">WebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span> <span class="built_in">this</span>.findWebApplicationContext();</span><br><span class="line">                <span class="keyword">if</span> (wac == <span class="literal">null</span>) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">"No WebApplicationContext found: no ContextLoaderListener or DispatcherServlet registered?"</span>);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                delegateToUse = <span class="built_in">this</span>.initDelegate(wac);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.delegate = delegateToUse;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.invokeDelegate(delegateToUse, request, response, filterChain);</span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="认证方式"><a href="#认证方式" class="headerlink" title="认证方式"></a>认证方式</h4>
          <h5 id="认证的概念"><a href="#认证的概念" class="headerlink" title="认证的概念"></a>认证的概念</h5>
          <blockquote>
            <p>所谓的认证,<hanla></hanla>就是用来判断系统中是否存在某用户,<hanla></hanla>并判断用户的身份是否是合法的过程，解决的其实是用户登录的问题，认证的存在，是为了保护系统中的隐私数据与资源，只有合法的用户才可以访问系统中的资源</p>
          </blockquote>
          <h5 id="HTTP基本认证"><a href="#HTTP基本认证" class="headerlink" title="HTTP基本认证"></a><code>HTTP</code>
            <hanla></hanla>基本认证
          </h5>
          <ul>
            <li>
              <p>基本认证</p>
              <blockquote>
                <p><code>HTTP</code>
                  <hanla></hanla>基本认证是在<hanla></hanla><code>RFC2616</code>
                  <hanla></hanla>标准中定义的一种认证模式，它以一种很简单的方式与用户进行交互。<code>HTTP</code>
                  <hanla></hanla>基本认证可以分为如下<hanla></hanla><code>4</code>
                  <hanla></hanla>个步骤
                </p>
              </blockquote>
              <ol>
                <li>客户端首先发起一个未携带认证信息的请求</li>
                <li>然后服务端返回一个<hanla></hanla><code>401 Unauthorized</code>
                  <hanla></hanla>的响应信息,<hanla></hanla>并在<hanla></hanla><code>WWW-Authentication</code>
                  <hanla></hanla>头部中说明认证形式: 当进行<hanla></hanla><code>HTTP</code>
                  <hanla></hanla>基本认证时,<code>WWW-Authentication</code>
                  <hanla></hanla>会被设置为<hanla></hanla><code>Basic relam="被保护的页面"</code>
                </li>
                <li>接下来客户端会收到<hanla></hanla><code>401 Unauthorized</code>
                  <hanla></hanla>响应信息,<hanla></hanla>并弹出一个对话框,<hanla></hanla>询问用户名和密码。当用户输入后，客户端会将用户名和密码使用<code>冒号</code>进行拼接并用<hanla></hanla><code>Nasr64</code>
                  <hanla></hanla>编码,<hanla></hanla>然后将其放入到请求的<hanla></hanla><code>Authorization</code>
                  <hanla></hanla>头部并发送给服务器
                </li>
                <li>最后服务器对客户端发来的信息进行解码得到用户名和密码,<hanla></hanla>并对该信息进行校验判断是否正确,<hanla></hanla>最终给客户端返回响应内容</li>
              </ol>
              <blockquote>
                <p><code>HTTP</code>
                  <hanla></hanla>基本认证是一种无状态的认证方式,<hanla></hanla>与表单认证相比,<code>HTTP</code>
                  <hanla></hanla>基本认证是一种基于<hanla></hanla><code>HTTP</code>
                  <hanla></hanla>层面的认证方式，无法携带<hanla></hanla><code>Session</code>
                  <hanla></hanla>信息,<hanla></hanla>也就无法实现<hanla></hanla><code>Remember-Me</code>
                  <hanla></hanla>功能，另外，用户名和密码在传递时仅做了一次简单的<hanla></hanla><code>Base64</code>
                  <hanla></hanla>编码，几乎等同于明文传输，极易被进行密码窃听和重放攻击。所以在实际开发中,<hanla></hanla>很少会使用这种认证方式来进行安全校验。
                </p>
              </blockquote>
            </li>
          </ul>
          <h5 id="Form表单认证"><a href="#Form表单认证" class="headerlink" title="Form表单认证"></a><code>Form</code>
            <hanla></hanla>表单认证<hanla></hanla>
          </h5>
          <h5 id="HTTP摘要认证"><a href="#HTTP摘要认证" class="headerlink" title="HTTP摘要认证"></a><code>HTTP</code>
            <hanla></hanla>摘要认证
          </h5>
          <ul>
            <li>
              <p>概念</p>
              <blockquote>
                <p><code>HTTP</code>
                  <hanla></hanla>摘要认证和<hanla></hanla><code>HTTP</code>
                  <hanla></hanla>基本认证一样,<hanla></hanla>也是在<hanla></hanla><code>RFC2616</code>
                  <hanla></hanla>中定义的一种认证方式，他的出现是为了弥补<hanla></hanla><code>HTTP</code>
                  <hanla></hanla>基本认证存在的安全隐患，但该认证方式也并不是很安全.<code>HTTP</code>
                  <hanla></hanla>摘要认证会使用对通信双方都可知的口令进行校验，且最终以密文的形式来传输数据，所以相对于基本认证,<hanla></hanla>稍微安全了一些
                </p>
              </blockquote>
            </li>
          </ul>
          <h4 id="登录页-自定义用户名和密码"><a href="#登录页-自定义用户名和密码" class="headerlink" title="登录页-自定义用户名和密码"></a>登录页-自定义用户名和密码</h4>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight properties">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">security</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">user</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">coder-itl</span></span><br><span class="line"><span class="comment">      # setPassword</span></span><br><span class="line">      <span class="attr">password</span>: <span class="string">root</span></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">// password: root 的源码<hanla></hanla></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> {</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(password)) {</span><br><span class="line">        <span class="comment">// 控制台生成密码的开关</span></span><br><span class="line">        <span class="built_in">this</span>.passwordGenerated = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="关闭验证功能"><a href="#关闭验证功能" class="headerlink" title="关闭验证功能"></a>关闭验证功能</h4>
          <ul>
            <li>
              <p>排除<hanla></hanla><code>Secuirty</code>
                <hanla></hanla>的配置,<hanla></hanla>让他不启用
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">// 启动类<hanla></hanla></span></span><br><span class="line"><span class="meta">@SpringBootApplication(exclude = {SecurityAutoConfiguration.class})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringSecurity01Application</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(SpringSecurity01Application.class, args);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="登录页-使用内存中的用户信息"><a href="#登录页-使用内存中的用户信息" class="headerlink" title="登录页-使用内存中的用户信息"></a>登录页-使用内存中的用户信息</h4>
          <ol>
            <li>
              <p>使用: <code>WebSecurityConfigurerAdapter</code>
                <hanla></hanla>控制安全管理的内容
              </p>
              <blockquote>
                <p>需要做的使用: 继承<hanla></hanla><code>WebSecurityConfigurerAdapter</code>，重写方法。实现自定义的认证信息</p>
              </blockquote>
            </li>
            <li>
              <p>创建<hanla></hanla><code>security</code>
                <hanla></hanla>的配置类
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="comment">// 在方法中配置 用户名和密码信息 作为登录的数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">PasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> passwordEncoder();</span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .withUser(<span class="string">"coder-itl"</span>).password(passwordEncoder.encode(<span class="string">"coder-itl"</span>)).roles();</span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .withUser(<span class="string">"admin"</span>).password(passwordEncoder.encode(<span class="string">"admin"</span>)).roles();</span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .withUser(<span class="string">"root"</span>).password(passwordEncoder.encode(<span class="string">"root"</span>)).roles();</span><br><span class="line">        </span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建密码的加密类</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 创建 PasswordEncoder 的实现类 实现类是加密算法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center">错误: 密码不能为明文信息，解决方法为添加加密</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/fb28b47a12164228a517e6087f60e131.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ol>
          <ul>
            <li>
              <p>基于角色<hanla></hanla><code>Role</code>
                <hanla></hanla>的身份认证，同一个用户可以有不同的角色。同时可以开启对方法级别的认证
              </p>
              <figure class="highlight properties">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="attr">@EnableGlobalMethodSecurity</span>: <span class="string">启用方法级别的认证</span></span><br><span class="line">	<span class="attr">prePostEnabled</span>: <span class="string">默认是 false</span></span><br><span class="line">		<span class="attr">true</span>: <span class="string">表示可以使用 @PreAuthorize 注解 和 @PostAuthorize</span></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">// 控制器编写: 基于内存中的用户信息认证<hanla></hanla></span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello SpringSecurity"</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 指定 normal 和 admin 都可以访问的方法</span></span><br><span class="line">    <span class="meta">@GetMapping("/helloUser")</span></span><br><span class="line">    <span class="meta">@PreAuthorize(value = "hasAnyRole('admin','normal')")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">helloCommonUser</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"normal 和 admin 都可以访问的方法"</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 仅 admin 可以访问的方法</span></span><br><span class="line">    <span class="meta">@GetMapping("/helloAdmin")</span></span><br><span class="line">    <span class="meta">@PreAuthorize(value = "hasAnyRole('admin')")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">helloAdmin</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"仅 admin 可以访问的方法"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>细节注意</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.oauth2.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * authorizeRequests: 授权请求</span></span><br><span class="line"><span class="comment">         * authenticated: 认证</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated().and()</span><br><span class="line">                <span class="comment">// 开启表单验证</span></span><br><span class="line">                .formLogin().loginPage(<span class="string">"/login.html"</span>).permitAll()</span><br><span class="line">                <span class="comment">// 当登录成功后，是否指定跳转到首页</span></span><br><span class="line">                .defaultSuccessUrl(<span class="string">"/index.html"</span>, <span class="literal">true</span>)</span><br><span class="line">                <span class="comment">// post 请求的登录接口</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">                <span class="comment">// 登录失败,<hanla></hanla>用户名或密码错误</span></span><br><span class="line">                .failureUrl(<span class="string">"/error.html"</span>)</span><br><span class="line">                <span class="comment">// 登录时携带的用户名和免密的表单的键</span></span><br><span class="line">                .usernameParameter(<span class="string">"username"</span>).passwordParameter(<span class="string">"password"</span>)</span><br><span class="line">                <span class="comment">// 注销</span></span><br><span class="line">                .and().logout().logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                <span class="comment">// 注销成功后的页面</span></span><br><span class="line">                .logoutSuccessUrl(<span class="string">"/login.html"</span>)</span><br><span class="line">                <span class="comment">// 删除自定义的 cookie</span></span><br><span class="line">                .deleteCookies(<span class="string">"myCookie"</span>)</span><br><span class="line">                <span class="comment">// 关闭 csrf 防护功能,<hanla></hanla>否则登录不成功</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置请求那些资源时不需要做认证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        web.ignoring().mvcMatchers(<span class="string">"/js/**"</span>, <span class="string">"/css/**"</span>, <span class="string">"/image/**"</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 基于内存的用户名和密码 */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 如果注入 passwordEncoder 会产生循环依赖，需要通过配置来进行打破循环依赖</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 生成密码的密文</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pwd</span> <span class="operator">=</span> passwordEncoder.encode(<span class="string">"user"</span>);</span><br><span class="line">        <span class="comment">// 设置用户名和密码</span></span><br><span class="line">        auth.inMemoryAuthentication().withUser(<span class="string">"user"</span>).password(pwd).roles(<span class="string">"admin"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight yml">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment"># 当注入了 PasswordEncoder 时<hanla></hanla></span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="comment"># 打破循环依赖</span></span><br><span class="line">    <span class="attr">allow-circular-references:</span> <span class="literal">true</span></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="角色-RBAC"><a href="#角色-RBAC" class="headerlink" title="角色- RBAC"></a>角色- RBAC</h4>
          <ul>
            <li>
              <p>认证</p>
              <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
                <p><code>身份认证</code>就是判断一个用户是否为合法用户的处理过程。<code>Spring Security</code>
                  <hanla></hanla>中支持多种不同方式的认证，但是无论开发者使用那种方式认证，都不会影响授权功能使用。因为<hanla></hanla><code>Spring Security</code>
                  <hanla></hanla>很好的做到了认证和授权解饿
                </p>
              </div>
            </li>
            <li>
              <p>授权</p>
              <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
                <p>即访问控制，控制谁能访问哪些资源。简单的理解授权就是根据系统提前设置好的规则，给用户分配可以访问某一个资源的权限，用户根据自己所具有的权限，去执行响应操作。</p>
              </div>
            </li>
            <li>
              <p>RBAC</p>
              <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
                <p>​ RBAC 是基于角色的访问控制<hanla></hanla>(<code>Role-Based Access Controle</code>)，在 RBAC 中,<hanla></hanla>权限与角色相关联，用户通过成为适当角色的成员而得到这些角色的权限。这就极大地简化了权限的管理。这样管理都是层级相互依赖的，权限赋予给角色，而把角色又赋予给用户</p>
                <p>​ 其基本思想是对系统操作的各种权限不是直接授予具体的用户，而是在用户集合之间建立一个角色集合。每一种角色对应一组相应的权限。一旦被用户分配到了适当的角色后，该用户就拥有此角色的所有操作权限。这样做的好处是，不必在每次创建用户时都进行分配权限的操作，只要分配用户相应的角色即可，而且角色的权限变更比用户的权限变更要少得多，这样就简化用户的权限管理，减少系统的开销</p>
              </div>
            </li>
            <li>
              <p>RBAC 中设计表</p>
              <ol>
                <li>用户表: 用户认证<hanla></hanla>(登录用到的表)，用户名、密码、是否启用，是否锁定等信息</li>
                <li>角色表: 定义角色信息，角色名称、角色的描述</li>
                <li>用户和角色的关系表：用户和角色是多对多的关系。一个用户可以又多个角色，一个角色可以有多个用户</li>
                <li>权限表：角色和权限的关系表，权限<hanla></hanla>(角色可以有那些权限)</li>
              </ol>
            </li>
          </ul>
          <h4 id="认证的接口和类"><a href="#认证的接口和类" class="headerlink" title="认证的接口和类"></a>认证的接口和类</h4>
          <ul>
            <li>
              <p><code>UserDetails</code>
                <hanla></hanla>接口
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetails</span> <span class="keyword">extends</span> <span class="title class_">Serializable</span> {</span><br><span class="line">    <span class="comment">// 权限的集合</span></span><br><span class="line">    Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 密码</span></span><br><span class="line">    String <span class="title function_">getPassword</span><span class="params">()</span>;</span><br><span class="line">	<span class="comment">// 用户名</span></span><br><span class="line">    String <span class="title function_">getUsername</span><span class="params">()</span>;</span><br><span class="line">	<span class="comment">//  账号是否过期</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span>;</span><br><span class="line">	<span class="comment">// 账号是否锁定</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span>;</span><br><span class="line">	<span class="comment">// 证书是否过期</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span>;</span><br><span class="line">	<span class="comment">// 是否启用</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p><code>UserDetails</code>
                <hanla></hanla>的实现类<hanla></hanla><code>User</code>
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义类可以实现 UserDetails 接口,<hanla></hanla>作为系统中的用户类。这个类可以交给 spring security 使用</span></span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center"><code>User</code></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/a55f15858d68486c976a72acec5cddf3.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p><code>UserDetailsService</code>
                <hanla></hanla>接口
              </p>
              <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
                <p>主要作用: 获取用户信息，得到的是<hanla></hanla><code>UserDetails</code>
                  <hanla></hanla>对象。一般项目中都需要自定义类实现这个接口，从数据库中获取数据
                </p>
              </div>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">// 一个方法要实现<hanla></hanla></span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line">    <span class="comment">// 根据用户名，获取用户信息</span></span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="自动配置分析"><a href="#自动配置分析" class="headerlink" title="自动配置分析"></a>自动配置分析</h4>
          <ul>
            <li>
              <p>自动配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="meta">@ConditionalOnDefaultWebSecurity</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SecurityFilterChainConfiguration</span> {</span><br><span class="line">        SecurityFilterChainConfiguration() {</span><br><span class="line">        }</span><br><span class="line">		<span class="comment">// 创建过滤器 SecurityFilterChain</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@Order(2147483642)</span></span><br><span class="line">        SecurityFilterChain <span class="title function_">defaultSecurityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">            ((ExpressionUrlAuthorizationConfigurer.AuthorizedUrl)http.authorizeRequests().anyRequest()).authenticated();		<span class="comment">// 表单认证</span></span><br><span class="line">            http.formLogin();</span><br><span class="line">            <span class="comment">// 早期的认证方式</span></span><br><span class="line">            http.httpBasic();</span><br><span class="line">            <span class="keyword">return</span> (SecurityFilterChain)http.build();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="生成默认登录页的流程分析"><a href="#生成默认登录页的流程分析" class="headerlink" title="生成默认登录页的流程分析"></a>生成默认登录页的流程分析</h4>
          <ul>
            <li>
              <p>流程图</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">流程分析</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/86c09cfc24a44d359b9156fd93b0e43f.png"></td>
                  </tr>
                </tbody>
              </table>
              <ul>
                <li>关键说明<ol>
                    <li>请求<hanla></hanla><code>/hello</code>
                      <hanla></hanla>接口,<hanla></hanla>在引入<hanla></hanla><code>spring security</code>
                      <hanla></hanla>之后会经过一系列过滤器
                    </li>
                    <li>在请求到达<hanla></hanla><code>FilterSecurityInterceptor</code>
                      <hanla></hanla>时,<hanla></hanla>发送请求并未认证。请求拦截下来，并抛出<hanla></hanla><code>AccessDeniedException</code>
                      <hanla></hanla>异常
                    </li>
                    <li>抛出<hanla></hanla><code>AccessDeniedException</code>
                      <hanla></hanla>的异常会被<hanla></hanla><code>ExceptionTranslationFilter</code>
                      <hanla></hanla>捕获，这个<hanla></hanla><code>Filter</code>
                      <hanla></hanla>中会调用<hanla></hanla><code>LoginUrlAuthenticationEntryPoint#commence</code>
                      <hanla></hanla>方法返回给客户端<hanla></hanla><code>302(重定向)</code>,<hanla></hanla>要求客户端进行重定向到<hanla></hanla><code>/login</code>
                      <hanla></hanla>页面
                    </li>
                    <li>客户端发送<hanla></hanla><code>/login</code>
                      <hanla></hanla>请求
                    </li>
                    <li><code>/login</code>
                      <hanla></hanla>请求会再次被拦截其中<hanla></hanla><code>DefaultLoginPageGeneratingFilter</code>
                      <hanla></hanla>拦截到,<hanla></hanla>并在拦截其中返回生成登录页面
                    </li>
                  </ol>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="自定义认证"><a href="#自定义认证" class="headerlink" title="自定义认证"></a>自定义认证</h4>
          <ul>
            <li>
              <p>需求</p>
              <ul>
                <li><code>index</code>
                  <hanla></hanla>公共资源
                </li>
                <li><code>hello</code>
                  <hanla></hanla>受限资源
                </li>
              </ul>
            </li>
            <li>
              <p>控制器</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 受保护资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello spring security"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 公共资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/index")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello index........."</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>创建配置类</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"></span><br><span class="line"><span class="comment">// WebSecurityConfigurerAdapter 在 2.7 过时<hanla></hanla></span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 放行资源在前 首先资源在后</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 匹配放行资源</span></span><br><span class="line">                .mvcMatchers(<span class="string">"/index"</span>).permitAll()</span><br><span class="line">                <span class="comment">// 其他皆是受保护资源</span></span><br><span class="line">                .anyRequest().authenticated().and().formLogin();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight properties">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment"># 说明</span></span><br><span class="line"><span class="attr">-</span> <span class="string">permitAll() 代表放行该资源 该资源为公共资源 无需认证和授权可以直接访问</span></span><br><span class="line"><span class="attr">-</span> <span class="string">anyRequest().authenticated() 代表所有请求,<hanla></hanla>必须认证后才能访问</span></span><br><span class="line"><span class="attr">-</span> <span class="string">formLogin() 代表开启表单认证</span></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="自定义登录页面"><a href="#自定义登录页面" class="headerlink" title="自定义登录页面"></a>自定义登录页面</h4>
          <ul>
            <li>
              <p><code>vue</code>
                <hanla></hanla>页面
              </p>
              <table>
                <thead>
                  <tr>
                    <th align="center">自定义页面</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/f0069229dcfb45aeb7686177e4d7118d.png"></td>
                  </tr>
                </tbody>
              </table>
              <ul>
                <li>
                  <p>修改默认访问页面</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="comment">// 配置类后续追加该配置 指定默认的登录页面</span></span><br><span class="line">.loginPage(<span class="string">"http://localhost:8081/#/login"</span>);</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
              </ul>
            </li>
            <li>
              <p><code>Thymeleaf</code>
                <hanla></hanla>使用
              </p>
              <ul>
                <li>
                  <p>添加依赖</p>
                  <figure class="highlight xml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>关闭缓存</p>
                  <figure class="highlight yml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>自定义登录页面</p>
                  <figure class="highlight html">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">content</span>=<span class="string">"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><hanla></hanla>自定义用户登录页面<hanla></hanla><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">form</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: orange;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@{/login}"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        用户名: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        密码: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登录"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>配置类中放行请求</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"></span><br><span class="line"><span class="comment">// WebSecurityConfigurerAdapter 在 2.7 过时<hanla></hanla></span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 放行资源在前 首先资源在后</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 匹配放行资源</span></span><br><span class="line">                .mvcMatchers(<span class="string">"/login"</span>).permitAll()</span><br><span class="line">                .mvcMatchers(<span class="string">"/index"</span>).permitAll()</span><br><span class="line">                <span class="comment">// 其他皆是受保护资源</span></span><br><span class="line">                .anyRequest().authenticated().and().formLogin()</span><br><span class="line">                <span class="comment">// 指定默认的登录页面 一旦自定义登录页面以后必须只能登录 url</span></span><br><span class="line">                .loginPage(<span class="string">"/login"</span>)</span><br><span class="line">                <span class="comment">// 指定处理登录请求 url</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">            	<span class="comment">// 指定<hanla></hanla>input name<hanla></hanla>属性值如果不是 username 和 password 时</span></span><br><span class="line">                .usernameParameter(<span class="string">"username"</span>)</span><br><span class="line">                .passwordParameter(<span class="string">"password"</span>)</span><br><span class="line">            </span><br><span class="line">            	 <span class="comment">// 传统开发: 认证成功后跳转<hanla></hanla>(只能选其一) forward(不改变路由):<hanla></hanla>始终在认证成功后跳转到指定请求 | redirect(改变路由) 根据上一次保存的请求进行成功跳转,<hanla></hanla>可通过修改参数强制跳转 .defaultSuccessUrl("/index",true) </span></span><br><span class="line">                .successForwardUrl(<span class="string">"/index"</span>)</span><br><span class="line">                .defaultSuccessUrl(<span class="string">"/index"</span>)</span><br><span class="line">            </span><br><span class="line">                <span class="comment">// 禁止 csrf 跨站请求保护</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="comment">// 前后端分离<hanla></hanla></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义认证成功之后的处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException {</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">"msg"</span>, <span class="string">"登录成功"</span>);</span><br><span class="line">        result.put(<span class="string">"status"</span>, <span class="string">"200"</span>);</span><br><span class="line">        result.put(<span class="string">"authentication"</span>, authentication);</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="comment">// 配置类添加如下配置</span></span><br><span class="line">.successHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationSuccessHandler</span>())</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">页面响应<hanla></hanla><code>json</code>
                          <hanla></hanla>数据
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/d5c0a258e0564d8abb570f7cb9d1b2f5.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
                <li>
                  <p>控制器</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/login")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// login.html</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>获取失败信息</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="comment">// 配置类中<hanla></hanla></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// forwald 错误信息存储在 request 作用域 </span></span><br><span class="line">.failureForwardUrl(<span class="string">"/login"</span>) </span><br><span class="line"><span class="comment">// redirect 错误信息村粗在 session 作用域</span></span><br><span class="line">.failureUrl(<span class="string">"/login"</span>)</span><br><span class="line">    </span><br><span class="line">   存储的键: SPRING_SECURITY_LAST_EXCEPTION	</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>前后端错误信息处理</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">.failureHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationFailureHandler</span>())</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 自定义认证失败<hanla></hanla></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException {</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">"msg"</span>, <span class="string">"登录失败: "</span> + exception.getMessage());</span><br><span class="line">        result.put(<span class="string">"status"</span>, <span class="number">500</span>);</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">输入错误的密码</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/9210949aee0d4b9da6d504401cbf1be4.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="注销"><a href="#注销" class="headerlink" title="注销"></a>注销</h4>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line">.and()</span><br><span class="line">    <span class="comment">//  logoutUrl | logoutRequestMatcher 选其一</span></span><br><span class="line">    .logout()</span><br><span class="line">    .logoutUrl(<span class="string">"/logout"</span>)  </span><br><span class="line">    <span class="comment">// 自定义退出路径与请求方式</span></span><br><span class="line">    .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">"/aa"</span>,<span class="string">"GET"</span>),</span><br><span class="line">        <span class="comment">// POST 请求的退出</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">"/bb"</span>,<span class="string">"POST"</span>)</span><br><span class="line">    ))</span><br><span class="line">    <span class="comment">// 退出成功后跳转的页面 默认<hanla></hanla>/login</span></span><br><span class="line">    .logoutSuccessUrl(<span class="string">"/login"</span>)</span><br><span class="line">    .logoutSuccessHandler(<span class="keyword">new</span> <span class="title class_">MyLogoutSuccessHandler</span>())</span><br><span class="line">    </span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>前端后端分离</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException {</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">"msg"</span>, <span class="string">"注销成功,<hanla></hanla>当前认证对象为: "</span> + authentication);</span><br><span class="line">        result.put(<span class="string">"status"</span>, <span class="string">"200"</span>);</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(json);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center">自定义注销</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/144bc254a2f5445d8257abd7fb87e484.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>
          <h4 id="完整配置顺序"><a href="#完整配置顺序" class="headerlink" title="完整配置顺序"></a>完整配置顺序</h4>
          <ul>
            <li>
              <p>顺序</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="comment">// 安全管理配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 所有请求</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">// 都需要认证</span></span><br><span class="line">                .authenticated()</span><br><span class="line">                <span class="comment">// 认证方式为表单认证</span></span><br><span class="line">                .and().formLogin()</span><br><span class="line">                <span class="comment">// 登录成功后</span></span><br><span class="line">                .successHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationSuccessHandler</span>())</span><br><span class="line">                <span class="comment">// 登录失败后</span></span><br><span class="line">                .failureHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationFailureHandler</span>())</span><br><span class="line">                .and().logout().logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .logout().logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                <span class="comment">// 退出成功后</span></span><br><span class="line">                .logoutSuccessHandler(<span class="keyword">new</span> <span class="title class_">MyLogoutSuccessHandler</span>())</span><br><span class="line">                <span class="comment">// 禁用跨站</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="WebSecurity和HttpSecurity"><a href="#WebSecurity和HttpSecurity" class="headerlink" title="WebSecurity和HttpSecurity"></a>WebSecurity<hanla></hanla>和<hanla></hanla>HttpSecurity</h4>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置请求那些资源时不需要做认证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    web.ignoring().mvcMatchers(<span class="string">"/js/**"</span>, <span class="string">"/css/**"</span>, <span class="string">"/image/**"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p><code>WebSecurity</code>: 在这个类里定义了一个<hanla></hanla><code>securityFilterChainBuilders</code>
                <hanla></hanla>集合，可以同时管理多个<hanla></hanla><code>SecurityFilterChain</code>
                <hanla></hanla>过滤器链，当<hanla></hanla><code>WebSecurity</code>
                <hanla></hanla>在执行时，会构建出一个名为<hanla></hanla><code>springSecurityFilterChain</code>
                <hanla></hanla>的<hanla></hanla><code>Spring BeanFilterChainProxy</code>
                <hanla></hanla>代理类，他的作用是定义那些请求客户忽略安全控制，那些请求必须接受安全控制，以及在合适的时候<code>清除 SecurityContext</code>
                <hanla></hanla>以避免内存泄漏，同时也可以用来<code>定义请求防火墙和请求拒绝处理器</code>,<hanla></hanla>也可以在这里开启<hanla></hanla><code>Spring Security</code>
                <hanla></hanla>的<hanla></hanla><code>Debug</code>
                <hanla></hanla>模式
              </p>
            </li>
            <li>
              <p><code>HttpSecurity</code>: <code>HttpSecurity</code>
                <hanla></hanla>用来构建包含一系列的过滤器链<hanla></hanla><code>SecurityFilterChain</code>，平常我们的配置就是围绕这个<hanla></hanla><code>SecurityFilterChain</code>
                <hanla></hanla>进行
              </p>
            </li>
          </ul>
          <h4 id="自定义数据源认证-一"><a href="#自定义数据源认证-一" class="headerlink" title="自定义数据源认证(一)"></a>自定义数据源认证<hanla></hanla>(一)</h4>
          <ul>
            <li>
              <p>用户表</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sys_user</span><br><span class="line">(</span><br><span class="line">    id            <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment comment <span class="string">'主键<hanla></hanla>id'</span>,</span><br><span class="line">    username      <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">'用户名'</span>,</span><br><span class="line">    password      <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">'密码'</span>,</span><br><span class="line">    realname      <span class="type">varchar</span>(<span class="number">200</span>) comment <span class="string">'实名用户名'</span>,</span><br><span class="line">    isexpire      <span class="type">int</span> comment <span class="string">'是否过期'</span>,</span><br><span class="line">    isenable      <span class="type">int</span> comment <span class="string">'是否禁用'</span>,</span><br><span class="line">    islock        <span class="type">int</span> comment <span class="string">'是否锁定'</span>,</span><br><span class="line">    iscredentials <span class="type">int</span> comment <span class="string">'证书是否可用'</span>,</span><br><span class="line">    createtime    <span class="type">date</span> comment <span class="string">'创建时间'</span>,</span><br><span class="line">    logintime     <span class="type">date</span> comment <span class="string">'登录时间'</span></span><br><span class="line">) comment <span class="string">'用户表'</span>;</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>角色表</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sys_role</span><br><span class="line">(</span><br><span class="line">    id       <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    rolename <span class="type">varchar</span>(<span class="number">255</span>) comment <span class="string">'角色名称'</span>,</span><br><span class="line">    rolememo <span class="type">varchar</span>(<span class="number">255</span>) comment <span class="string">'角色描述'</span></span><br><span class="line">) comment <span class="string">'角色表'</span>;</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>角色用户对应关系表</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sys_user_role</span><br><span class="line">(</span><br><span class="line">    userid <span class="type">int</span>,</span><br><span class="line">    roleid <span class="type">int</span></span><br><span class="line">) comment <span class="string">'用户角色关系对应表'</span>;</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center">表信息</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/8af4ef53aa2c4ff590a07924b43bced5.png" alt="在这里插入图片描述"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>创建项目</p>
              <ul>
                <li>
                  <p>添加依赖</p>
                  <figure class="highlight xml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>配置</p>
                  <figure class="highlight yml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/security?useUnicode=true&amp;serverTimezone=GMT&amp;characterEncoding=UTF-8&amp;useSSL=false</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.example.entity</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">com/example/mapper/*.Mapper</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.example.mapper:</span> <span class="string">debug</span></span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>自定义<hanla></hanla><code>User</code>
                    <hanla></hanla>实现<hanla></hanla><code>UserDetails</code>
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.entity;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> {</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String realname;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否过期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isExpired;</span><br><span class="line">    <span class="comment">// 是否锁定</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isLocked;</span><br><span class="line">    <span class="comment">// 凭证是否有效</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isCredentials;</span><br><span class="line">    <span class="comment">// 是否启用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Date loginTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;GrantedAuthority&gt; authorities;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() {</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> isExpired;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> isLocked;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> isCredentials;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> isEnabled;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>角色</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.entity;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysRole</span> {</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String rolename;</span><br><span class="line">    <span class="keyword">private</span> String rolememo;</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>实现<hanla></hanla><code>service</code></p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcUSerServiceDetail</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> {</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SysUserMapper sysUserMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SysRoleMapper sysRoleMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line">        log.info(<span class="string">"username: [{}]"</span>, username);</span><br><span class="line">        <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 角色信息集合</span></span><br><span class="line">        List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 1. 根据用户名查询用户信息</span></span><br><span class="line">        <span class="keyword">if</span> (username != <span class="literal">null</span>) {</span><br><span class="line">            sysUser = sysUserMapper.selectSysUser(username);</span><br><span class="line">            log.error(<span class="string">"sysUser: [{}]"</span>, sysUser.toString());</span><br><span class="line">            <span class="type">String</span> <span class="variable">roleName</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">if</span> (sysUser != <span class="literal">null</span>) {</span><br><span class="line">        </span><br><span class="line">                List&lt;SysRole&gt; roleList = sysRoleMapper.selectRoleByUser(sysUser.getId());</span><br><span class="line">                log.error(<span class="string">"roleList: [{}]"</span>, roleList.toString());</span><br><span class="line">                <span class="keyword">for</span> (SysRole role : roleList) {</span><br><span class="line">                    roleName = role.getRolename();</span><br><span class="line">                    <span class="type">GrantedAuthority</span> <span class="variable">authority</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">"ROLE_"</span> + roleName);</span><br><span class="line">                    authorities.add(authority);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            sysUser.setAuthorities(authorities);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> sysUser;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>Security</code>
                    <hanla></hanla>配置类
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerWebSecurityConfigurerAdapter</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        log.error(<span class="string">"config HttpSecurity..........."</span>);</span><br><span class="line">        http.authorizeRequests().antMatchers(<span class="string">"/index"</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">"/access/read"</span>).hasRole(<span class="string">"READ"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/access/user"</span>).hasRole(<span class="string">"USER"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/access/admin"</span>).hasRole(<span class="string">"ADMIN"</span>)</span><br><span class="line">                <span class="comment">// 其他皆是受保护资源</span></span><br><span class="line">                .anyRequest().authenticated().and().formLogin();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 实现自定义 new BCryptPasswordEncoder()</span></span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>创建<hanla></hanla><code>mapper</code></p>
                  <figure class="highlight xml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.mapper.SysUserMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userMap"</span> <span class="attr">type</span>=<span class="string">"sysUser"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  column: 数据库列明 property: 实体字段名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"username"</span> <span class="attr">property</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"password"</span> <span class="attr">property</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"realname"</span> <span class="attr">property</span>=<span class="string">"realname"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"isexpire"</span> <span class="attr">property</span>=<span class="string">"isExpired"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"isenable"</span> <span class="attr">property</span>=<span class="string">"isEnabled"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"islock"</span> <span class="attr">property</span>=<span class="string">"isLocked"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"iscredentials"</span> <span class="attr">property</span>=<span class="string">"isCredentials"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"createtime"</span> <span class="attr">property</span>=<span class="string">"createTime"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"logintime"</span> <span class="attr">property</span>=<span class="string">"loginTime"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- int insertSysUser(SysUser user); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertSysUser"</span> <span class="attr">parameterType</span>=<span class="string">"sysUser"</span>&gt;</span></span><br><span class="line">        insert into sys_user(username,</span><br><span class="line">                             password,</span><br><span class="line">                             realname,</span><br><span class="line">                             isenable,</span><br><span class="line">                             islock,</span><br><span class="line">                             isexpire,</span><br><span class="line">                             iscredentials,</span><br><span class="line">                             createtime,</span><br><span class="line">                             logintime)</span><br><span class="line">        values (#{username},</span><br><span class="line">                #{password},</span><br><span class="line">                #{realname},</span><br><span class="line">                #{isEnabled},</span><br><span class="line">                #{isLocked},</span><br><span class="line">                #{isExpired},</span><br><span class="line">                #{isCredentials},</span><br><span class="line">                #{createTime},</span><br><span class="line">                #{loginTime})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- SysUser selectSysUser(String username); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectSysUser"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultMap</span>=<span class="string">"userMap"</span>&gt;</span></span><br><span class="line">        select *</span><br><span class="line">        from sys_user</span><br><span class="line">        where username = #{username}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <figure class="highlight xml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.mapper.SysRoleMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- List&lt;SysRole&gt; selectRoleByUser(Integer userId); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectRoleByUser"</span> <span class="attr">parameterType</span>=<span class="string">"integer"</span> <span class="attr">resultType</span>=<span class="string">"sysRole"</span>&gt;</span></span><br><span class="line">        select r.id, r.rolename, r.rolememo</span><br><span class="line">        from sys_user_role ur,</span><br><span class="line">             sys_role r</span><br><span class="line">        where ur.roleid = r.id</span><br><span class="line">          and ur.userid = #{userId}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>初始化信息</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">PasswordEncoder</span> <span class="variable">pwdEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">        <span class="type">Date</span> <span class="variable">curDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        List&lt;GrantedAuthority&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 参数角色名称 必须以"ROLE_"开头 后面加上自定义的角色名称</span></span><br><span class="line">		<span class="comment">// GrantedAuthority read = new SimpleGrantedAuthority("ROLE_" + "READ");</span></span><br><span class="line">		<span class="comment">// GrantedAuthority user = new SimpleGrantedAuthority("ROLE_" + "USER");</span></span><br><span class="line">        <span class="type">GrantedAuthority</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">"ROLE_"</span> + <span class="string">"ADMIN"</span>);</span><br><span class="line">        <span class="comment">//        list.add(read);</span></span><br><span class="line">        <span class="comment">//        list.add(user);</span></span><br><span class="line">        <span class="comment">//        list.add(admin);</span></span><br><span class="line">        <span class="comment">// 普通用户</span></span><br><span class="line">		<span class="comment">// SysUser lisiRead = new SysUser(1, "lisi", pwdEncoder.encode("lisi"), "李四", true, true, true, true, curDate, curDate, list);</span></span><br><span class="line">		<span class="comment">// SysUser zsUser= new SysUser(2, "zs", pwdEncoder.encode("zs"), "张三", true, true, true, true, curDate, curDate, list);</span></span><br><span class="line">        <span class="type">SysUser</span> <span class="variable">coderitlAdmin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SysUser</span>(<span class="number">3</span>, <span class="string">"coder-itl"</span>, pwdEncoder.encode(<span class="string">"coder-itl"</span>), <span class="string">"CODER-ITL"</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, curDate, curDate, list);</span><br><span class="line">		<span class="comment">// sysUserMapper.insertSysUser(lisiRead);</span></span><br><span class="line">		<span class="comment">// sysUserMapper.insertSysUser(zsUser);</span></span><br><span class="line">        sysUserMapper.insertSysUser(coderitlAdmin);</span><br><span class="line">    }</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>源文件</p>
                  <blockquote>
                    <p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gitee.com/coder-itl/spring-security.git">https://gitee.com/coder-itl/spring-security.git</a></p>
                  </blockquote>
                </li>
                <li>
                  <p>静态页面跳转</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/index")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"forward:/index.html"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <table>
                    <thead>
                      <tr>
                        <th align="center"><code>index</code>
                          <hanla></hanla>实现跳转
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/cf1f8c7661a24790838d7af3f79c2714.png"></td>
                      </tr>
                    </tbody>
                  </table>
                  <ul>
                    <li>
                      <p><code>静态页面</code></p>
                      <figure class="highlight html">
                        <table>
                          <tbody>
                            <tr>
                              <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                              </td>
                              <td class="code">
                                <pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/access/read"</span>&gt;</span><hanla></hanla>只读-李四<hanla></hanla><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/access/user"</span>&gt;</span><hanla></hanla>普通用户-张三<hanla></hanla><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/access/admin"</span>&gt;</span>CODER-ITL 管理员<hanla></hanla><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </figure>
                    </li>
                    <li>
                      <p>控制器</p>
                      <figure class="highlight java">
                        <table>
                          <tbody>
                            <tr>
                              <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                              </td>
                              <td class="code">
                                <pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/access/user")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">accessZS</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"zs and admin....."</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping("/access/read")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">accessRD</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"lisi....."</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping("/access/admin")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">accessAM</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"admin....."</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </figure>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="自定义数据源认证-二"><a href="#自定义数据源认证-二" class="headerlink" title="自定义数据源认证(二)"></a>自定义数据源认证<hanla></hanla>(二)</h4>
          <ul>
            <li>
              <p><code>spring-security</code>
                <hanla></hanla>中的<hanla></hanla><code>User</code>
              </p>
              <table>
                <thead>
                  <tr>
                    <th align="center"><code>User</code></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/502c6b40bd97456893ce1005ed3687a9.png" alt="在这里插入图片描述"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>设计表结构</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">-- 用户表<hanla></hanla></span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'用户<hanla></hanla>ID'</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'用户名'</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'密码'</span>,</span><br><span class="line">  `enabled` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'是否启用'</span>,</span><br><span class="line">  `accountNonExpired` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'账户是否过期'</span>,</span><br><span class="line">  `accountNonLocked` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'账户是否锁定'</span>,</span><br><span class="line">  `credentialsNonExpired` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'凭证是否过期'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">-- 插入用户数据<hanla></hanla></span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'root'</span>, <span class="string">'{noop}123'</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">'admin'</span>, <span class="string">'{noop}123'</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">'coder-itl'</span>, <span class="string">'{noop}123'</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'角色<hanla></hanla>ID'</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'角色名称'</span>,</span><br><span class="line">  `name_zh` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'角色中文名称'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> role <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'ROLE_product'</span>,<span class="string">'商品管理员'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> role <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">'ROLE_admin'</span>,<span class="string">'系统管理员'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> role <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'ROLE_user'</span>,<span class="string">'用户管理员'</span>);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_role` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `uid` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rid` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `uid` (`uid`),</span><br><span class="line">  KEY `rid` (`rid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center">表结构</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/dec4fd06de044e3c946804db11702c2a.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>自定义<hanla></hanla><code>User</code></p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> {</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Boolean enabled;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonExpired;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonLocked;</span><br><span class="line">    <span class="keyword">private</span> Boolean credentialsNonExpired;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 权限集合</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() {</span><br><span class="line">        Set&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        roles.forEach(role -&gt; {</span><br><span class="line">            <span class="type">SimpleGrantedAuthority</span> <span class="variable">simpleGrantedAuthority</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(role.getName());</span><br><span class="line">            authorities.add(simpleGrantedAuthority);</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> accountNonExpired;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> accountNonLocked;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> credentialsNonExpired;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> enabled;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p><code>Role</code></p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> {</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String nameZh;</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p><code>mapper</code></p>
              <figure class="highlight xml">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.mapper.UserMapper"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- User findUserByUserName(String username); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findUserByUserName"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        select *</span><br><span class="line">        from user</span><br><span class="line">        where username = #{username}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- List&lt;Role&gt; getRoleByUid(Integer uid); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRoleByUid"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select r.id, r.name, r.name_zh</span><br><span class="line">        from role r,</span><br><span class="line">             user_role ur</span><br><span class="line">        where r.id = ur.uid</span><br><span class="line">          and ur.uid = #{uid}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p><code>UserDetailsService</code>
                <hanla></hanla>实现
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.entity.Role;</span><br><span class="line"><span class="keyword">import</span> com.example.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyUserDetailsService</span><span class="params">(<span class="keyword">final</span> UserMapper userMapper)</span> {</span><br><span class="line">        <span class="built_in">this</span>.userMapper = userMapper;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line">        <span class="comment">// 根据用户名查询用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.findUserByUserName(username);</span><br><span class="line">        <span class="comment">// 如果用户为空</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(user)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">"用户名错误!"</span>);</span><br><span class="line">        <span class="comment">// 查询权限信息</span></span><br><span class="line">        List&lt;Role&gt; roles = userMapper.getRoleByUid(user.getId());</span><br><span class="line">        user.setRoles(roles);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>配置<hanla></hanla><code>SpringSecurity</code></p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.service.MyUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="keyword">private</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(<span class="keyword">final</span> MyUserDetailsService myUserDetailsService)</span> {</span><br><span class="line">        <span class="built_in">this</span>.myUserDetailsService = myUserDetailsService;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自定义  AuthenticationManager 推荐 并没有在工厂在暴露出来</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        log.error(<span class="string">"自定义 AuthenticationManager: "</span> + builder);</span><br><span class="line">        builder.userDetailsService(myUserDetailsService);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 作用: 用来将自定义 AuthenticationManager 在工厂中进行暴露 可以在任意位置注入</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated().and().formLogin().and().csrf().disable();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="传统-WEB-开发认证总结案例"><a href="#传统-WEB-开发认证总结案例" class="headerlink" title="传统 WEB 开发认证总结案例"></a>传统 WEB 开发认证总结案例</h4>
          <ul>
            <li>
              <p><code>SpringMVC</code>
                <hanla></hanla>的自定义配置
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ViewControllerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对 springmvc 进行自定义配置: 可以省略部分控制器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfigure</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> {</span><br><span class="line">        registry.addViewController(<span class="string">"/login"</span>).setViewName(<span class="string">"login"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/index"</span>).setViewName(<span class="string">"index"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>传统<hanla></hanla><code>web</code>
                <hanla></hanla>的<hanla></hanla><code>Security</code>
                <hanla></hanla>所有配置
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 开启认证</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 放行的资源</span></span><br><span class="line">                .mvcMatchers(<span class="string">"/login"</span>, <span class="string">"/index"</span>).permitAll()</span><br><span class="line">                <span class="comment">// 所有请求都需要认证</span></span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                <span class="comment">// 表单认证 指定自定义登录页面</span></span><br><span class="line">                .and().formLogin().loginPage(<span class="string">"/login"</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">                <span class="comment">// 指定用户名 和 密码的 name 属性值</span></span><br><span class="line">                .usernameParameter(<span class="string">"username"</span>)</span><br><span class="line">                .passwordParameter(<span class="string">"password"</span>)</span><br><span class="line">                <span class="comment">// 登录成功后跳转的页面</span></span><br><span class="line">                .defaultSuccessUrl(<span class="string">"/index"</span>)</span><br><span class="line">                <span class="comment">// 退出</span></span><br><span class="line">                .and().logout()</span><br><span class="line">                <span class="comment">// 退出成功后的跳转<hanla></hanla>(默认 login)</span></span><br><span class="line">                .logoutSuccessUrl(<span class="string">"/login"</span>)</span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="前后端分离认证总结"><a href="#前后端分离认证总结" class="headerlink" title="前后端分离认证总结"></a>前后端分离认证总结</h4>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.filter.LoginFilter;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="comment">// 使用内存中的用户认证</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">"root"</span>).password(<span class="string">"{noop}123"</span>).roles(<span class="string">"admin"</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自定义 filter 交给工厂管理</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginFilter <span class="title function_">loginFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">LoginFilter</span> <span class="variable">loginFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginFilter</span>();</span><br><span class="line">        <span class="comment">// 接受指定的 json 用户名 key</span></span><br><span class="line">        loginFilter.setUsernameParameter(<span class="string">"username"</span>);</span><br><span class="line">        <span class="comment">// 接受指定的 json 密码 key</span></span><br><span class="line">        loginFilter.setPasswordParameter(<span class="string">"password"</span>);</span><br><span class="line">        <span class="comment">// 注入 authdicationManager</span></span><br><span class="line">        loginFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="comment">// 认证成功后</span></span><br><span class="line">        loginFilter.setAuthenticationSuccessHandler((req, resp, auth) -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            result.put(<span class="string">"msg"</span>, <span class="string">"登录成功"</span>);</span><br><span class="line">            <span class="comment">// 状态码: 200</span></span><br><span class="line">            resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">            result.put(<span class="string">"authentication"</span>, auth);</span><br><span class="line">            resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(json);</span><br><span class="line">        });</span><br><span class="line">        <span class="comment">// 认证失败后</span></span><br><span class="line">        loginFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            result.put(<span class="string">"msg"</span>, <span class="string">"登录失败: "</span> + ex.getMessage());</span><br><span class="line">            <span class="comment">// 服务器内部错误 状态码: 500</span></span><br><span class="line">            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">            resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(json);</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> loginFilter;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置安全</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 所有请求都需要认证</span></span><br><span class="line">                .anyRequest().authenticated().and().formLogin()</span><br><span class="line">                <span class="comment">// 退出</span></span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, ex) -&gt; {</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"请认证之后再去处理...."</span>);</span><br><span class="line">                    result.put(<span class="string">"status"</span>, HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(json);</span><br><span class="line">                })</span><br><span class="line">                .and()</span><br><span class="line">                .logout().logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                <span class="comment">// 退出成功后</span></span><br><span class="line">                .logoutSuccessHandler((req, resp, auth) -&gt; {</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"注销成功"</span>);</span><br><span class="line">                    result.put(<span class="string">"authentication"</span>, auth.getPrincipal());</span><br><span class="line">                    resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                    resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(json);</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 禁用跨站</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">        <span class="comment">// at: 用在某个 filter 替换过滤器链中哪个 filter</span></span><br><span class="line">        <span class="comment">// before: 放在过滤器链中那个 filter 之前</span></span><br><span class="line">        <span class="comment">// after: 放在过滤器链中那个 filter 之后</span></span><br><span class="line">        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>控制器</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/test")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test ok..........................."</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>自定义前后端认证</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationServiceException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义前后端认证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> {</span><br><span class="line">        log.error(<span class="string">"attemptAuthentication: [{}]"</span>, <span class="string">"Override attemptAuthentication..................................."</span>);</span><br><span class="line">        <span class="comment">// 1. 判断请求方式是否是 POST</span></span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">"POST"</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 2. 判断 数据是否是 JSON 格式</span></span><br><span class="line">        <span class="keyword">if</span> (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 将请求体中的数据进行反序列化</span></span><br><span class="line">                Map&lt;String, String&gt; userInfo = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);</span><br><span class="line">                <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> userInfo.get(getUsernameParameter());</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userInfo.get(getPasswordParameter());</span><br><span class="line">                log.error(<span class="string">"username: [{}]"</span>, username);</span><br><span class="line">                log.error(<span class="string">"password: [{}]"</span>, password);</span><br><span class="line">                <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">                <span class="built_in">this</span>.setDetails(request, authRequest);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 如果不是 JSON 格式数据,<hanla></hanla>则调用传统方式进行认证</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>访问测试</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">访问成功</th>
                    <th align="center">访问失败</th>
                    <th align="center">注销成功</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/1c4e6b6b663041198e1c2e508f2817aa.png"></td>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/e9450da6b4514d3284cf5daa7c835a06.png"></td>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/f0623f03df40407fa0a06a97c6ffa06d.png" alt="在这里插入图片描述"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>更改内存数据源为数据库</p>
              <ul>
                <li>
                  <p>实现<hanla></hanla><code>service</code></p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.entity.Role;</span><br><span class="line"><span class="keyword">import</span> com.example.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyUserDetailsService</span><span class="params">(<span class="keyword">final</span> UserMapper userMapper)</span> {</span><br><span class="line">        <span class="built_in">this</span>.userMapper = userMapper;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line">        <span class="comment">// 根据用户名查询用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.findUserByUserName(username);</span><br><span class="line">        <span class="comment">// 如果用户为空</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(user)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">"用户名错误!"</span>);</span><br><span class="line">        <span class="comment">// 查询权限信息</span></span><br><span class="line">        List&lt;Role&gt; roles = userMapper.getRoleByUid(user.getId());</span><br><span class="line">        user.setRoles(roles);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>配置修改</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="comment">// 使用数据库中的用户认证</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfigure</span><span class="params">(<span class="keyword">final</span> MyUserDetailsService myUserDetailsService)</span> {</span><br><span class="line">        <span class="built_in">this</span>.myUserDetailsService = myUserDetailsService;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        auth.userDetailsService(myUserDetailsService);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>UserMapper.java</code></p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> {</span><br><span class="line">    User <span class="title function_">findUserByUserName</span><span class="params">(String username)</span>;</span><br><span class="line">    </span><br><span class="line">    List&lt;Role&gt; <span class="title function_">getRoleByUid</span><span class="params">(Integer id)</span>;</span><br><span class="line">}</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>UserMapper.xml</code></p>
                  <figure class="highlight xml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.mapper.UserMapper"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- User findUserByUserName(String username); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findUserByUserName"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        select *</span><br><span class="line">        from user</span><br><span class="line">        where username = #{username}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- List&lt;Role&gt; getRoleByUid(Integer uid); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRoleByUid"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select r.id, r.name, r.name_zh</span><br><span class="line">        from role r,</span><br><span class="line">             user_role ur</span><br><span class="line">        where r.id = ur.uid</span><br><span class="line">          and ur.uid = #{uid}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>数据源配置</p>
                </li>
                <li>
                  <p>访问测试</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">调试<hanla></hanla><code>loadUserByUsername</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/39b10e57177842be90fabb00ea3cf1c8.png"></td>
                      </tr>
                    </tbody>
                  </table>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">前后端只能通过其他工具测试，浏览器不支持</th>
                        <th align="center">成功访问</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/22238bbb55c54d65b3e54011d3c3fec0.png"></td>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/2d809a9939be4f7d9357b22a756681a3.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="添加认证验证码"><a href="#添加认证验证码" class="headerlink" title="添加认证验证码"></a>添加认证验证码</h4>
          <ul>
            <li>
              <p>添加依赖</p>
              <figure class="highlight xml">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>自定义验证码生成</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/captcha")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaController</span> {</span><br><span class="line">    <span class="comment">// 图像宽度 150px</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> <span class="number">150</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">    <span class="comment">// 图片内容起始位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">drawY</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line">    <span class="comment">// 文字间隔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">space</span> <span class="operator">=</span> <span class="number">18</span>;</span><br><span class="line">    <span class="comment">// 验证码文字个数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">charCount</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line">    <span class="comment">// 验证码内容数组</span></span><br><span class="line">    <span class="keyword">private</span> String[] code = {</span><br><span class="line">            <span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>, <span class="string">"D"</span>, <span class="string">"E"</span>, <span class="string">"F"</span>, <span class="string">"G"</span>, <span class="string">"H"</span>, <span class="string">"K"</span>, <span class="string">"Z"</span>, <span class="string">"X"</span>, <span class="string">"L"</span>, <span class="string">"C"</span>, <span class="string">"V"</span>, <span class="string">"B"</span>, <span class="string">"N"</span>, <span class="string">"M"</span>, <span class="string">"Q"</span>, <span class="string">"W"</span>,</span><br><span class="line">            <span class="string">"R"</span>, <span class="string">"T"</span>, <span class="string">"Y"</span>, <span class="string">"U"</span>, <span class="string">"I"</span>, <span class="string">"O"</span>, <span class="string">"P"</span>, <span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"g"</span>, <span class="string">"h"</span>, <span class="string">"k"</span>, <span class="string">"z"</span>, <span class="string">"x"</span>,</span><br><span class="line">            <span class="string">"l"</span>, <span class="string">"c"</span>, <span class="string">"v"</span>, <span class="string">"b"</span>, <span class="string">"n"</span>, <span class="string">"m"</span>, <span class="string">"q"</span>, <span class="string">"w"</span>, <span class="string">"r"</span>, <span class="string">"t"</span>, <span class="string">"y"</span>, <span class="string">"u"</span>, <span class="string">"i"</span>, <span class="string">"o"</span>, <span class="string">"p"</span>,</span><br><span class="line">            <span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"5"</span>, <span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"8"</span>, <span class="string">"9"</span>, <span class="string">"0"</span></span><br><span class="line">    };</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping("/code")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeCode</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="comment">// 创建一个背景透明的图片 使用 rgb 表示颜色的</span></span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        <span class="comment">// 获取画笔</span></span><br><span class="line">        <span class="type">Graphics</span> <span class="variable">graphics</span> <span class="operator">=</span> image.getGraphics();</span><br><span class="line">        <span class="comment">// 设置使用的画笔是白颜色</span></span><br><span class="line">        graphics.setColor(Color.white);</span><br><span class="line">        <span class="comment">// 给 inage 画板都涂成白色的</span></span><br><span class="line">        <span class="comment">// fillRect(矩形)(矩形的起始<hanla></hanla>x,<hanla></hanla>矩形的起始<hanla></hanla>y,width,height)</span></span><br><span class="line">        graphics.fillRect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">        <span class="comment">// 将文字内容输出到图片上</span></span><br><span class="line">        <span class="comment">// 1. 创建一个字体</span></span><br><span class="line">        <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Font</span>(<span class="string">"宋体"</span>, Font.BOLD, <span class="number">16</span>);</span><br><span class="line">        graphics.setFont(font);</span><br><span class="line">        <span class="comment">// 设置画笔颜色</span></span><br><span class="line">        graphics.setColor(Color.black);</span><br><span class="line">        <span class="comment">// 2. 在画布上添加文字</span></span><br><span class="line">        <span class="comment">// graphics.drawString("中", 20, drawY);</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ran</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> code.length;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; charCount; i++) {</span><br><span class="line">            ran = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(len);</span><br><span class="line">            <span class="comment">// 使用随机颜色绘制</span></span><br><span class="line">            graphics.setColor(randomColor());</span><br><span class="line">            stringBuffer.append(code[ran]);</span><br><span class="line">            graphics.drawString(code[ran], (i + <span class="number">1</span>) * space, drawY);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 将验证码存储到 session</span></span><br><span class="line">        request.getSession().setAttribute(<span class="string">"code"</span>, stringBuffer);</span><br><span class="line">        <span class="comment">// 绘制干扰线</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) {</span><br><span class="line">            graphics.setColor(randomColor());</span><br><span class="line">            <span class="type">int</span> dot[] = makeLineDot();</span><br><span class="line">            graphics.drawLine(dot[<span class="number">0</span>], dot[<span class="number">1</span>], dot[<span class="number">2</span>], dot[<span class="number">3</span>]);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 设置响应格式</span></span><br><span class="line">        response.setContentType(<span class="string">"image/png"</span>);</span><br><span class="line">        <span class="comment">// 缓存设置</span></span><br><span class="line">        response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">        response.setDateHeader(<span class="string">"Expires"</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        ImageIO.write(image, <span class="string">"png"</span>, outputStream);</span><br><span class="line">        outputStream.flush();</span><br><span class="line">        outputStream.close();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成随机颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Color <span class="title function_">randomColor</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">255</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">g</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">255</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">255</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color</span>(r, g, b);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] makeLineDot() {</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">x1</span> <span class="operator">=</span> random.nextInt(width / <span class="number">2</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">y1</span> <span class="operator">=</span> random.nextInt(height);</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">x2</span> <span class="operator">=</span> random.nextInt(width);</span><br><span class="line">        <span class="type">int</span> <span class="variable">y2</span> <span class="operator">=</span> random.nextInt(height);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]{x1, x2, y1, y2};</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>传统<hanla></hanla><code>WEB</code>
                <hanla></hanla>验证码添加
              </p>
              <ul>
                <li>
                  <p>添加谷歌验证码配置</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.Producer;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaConfig</span> {</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Producer <span class="title function_">kaptcha</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.image.width"</span>, <span class="string">"150"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.image.height"</span>, <span class="string">"50"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.char.string"</span>, <span class="string">"0123456789"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.char.length"</span>, <span class="string">"4"</span>);</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>(properties);</span><br><span class="line">        <span class="type">DefaultKaptcha</span> <span class="variable">defaultKaptcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line">        defaultKaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>自定义过滤器</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.exception.KaptchaNotMatchException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationServiceException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义前后端认证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FORM_KAPTCHA_KEY</span> <span class="operator">=</span> <span class="string">"code"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">kaptchaParameter</span> <span class="operator">=</span> FORM_KAPTCHA_KEY;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKaptchaParameter</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.kaptchaParameter;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKaptchaParameter</span><span class="params">(<span class="keyword">final</span> String kaptchaParameter)</span> {</span><br><span class="line">        <span class="built_in">this</span>.kaptchaParameter = kaptchaParameter;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> {</span><br><span class="line">        log.error(<span class="string">"attemptAuthentication: [{}]"</span>, <span class="string">"Override attemptAuthentication..................................."</span>);</span><br><span class="line">        <span class="comment">// 1. 判断请求方式是否是 POST</span></span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">"POST"</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 先进行验证码校验</span></span><br><span class="line">        <span class="comment">// 获取请求中的验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">parameter</span> <span class="operator">=</span> request.getParameter(getKaptchaParameter());</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">"kaptcha"</span>);</span><br><span class="line">        <span class="comment">// 用户输入的验证码和 session 作用域中的都不能为空</span></span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(parameter) &amp;&amp; !ObjectUtils.isEmpty(code) &amp;&amp; parameter.equalsIgnoreCase(code)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 没有通过则执行自定义异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KaptchaNotMatchException</span>(<span class="string">"验证码不匹配!"</span>);</span><br><span class="line">   </span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>自定义验证码异常</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.exception;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaNotMatchException</span> <span class="keyword">extends</span> <span class="title class_">AuthenticationException</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg, Throwable cause)</span> {</span><br><span class="line">        <span class="built_in">super</span>(msg, cause);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg)</span> {</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>Security</code>
                    <hanla></hanla>配置类
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.filter.LoginFilter;</span><br><span class="line"><span class="keyword">import</span> com.example.service.MyUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="comment">// 使用数据库中的用户认证</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfigure</span><span class="params">(<span class="keyword">final</span> MyUserDetailsService myUserDetailsService)</span> {</span><br><span class="line">        <span class="built_in">this</span>.myUserDetailsService = myUserDetailsService;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        auth.userDetailsService(myUserDetailsService);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自定义 filter 交给工厂管理</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginFilter <span class="title function_">loginFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">LoginFilter</span> <span class="variable">loginFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginFilter</span>();</span><br><span class="line">        <span class="comment">// 接受指定的 json 用户名 key</span></span><br><span class="line">        loginFilter.setUsernameParameter(<span class="string">"username"</span>);</span><br><span class="line">        <span class="comment">// 接受指定的 json 密码 key</span></span><br><span class="line">        loginFilter.setPasswordParameter(<span class="string">"password"</span>);</span><br><span class="line">        <span class="comment">// 接受指定的 json 验证码 key</span></span><br><span class="line">        loginFilter.setKaptchaParameter(<span class="string">"code"</span>);</span><br><span class="line">        <span class="comment">// 注入 authdicationManager</span></span><br><span class="line">        loginFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="comment">// 认证成功后</span></span><br><span class="line">        loginFilter.setAuthenticationSuccessHandler((req, resp, auth) -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            result.put(<span class="string">"msg"</span>, <span class="string">"登录成功"</span>);</span><br><span class="line">            <span class="comment">// 状态码: 200</span></span><br><span class="line">            resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">            result.put(<span class="string">"authentication"</span>, auth);</span><br><span class="line">            resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(json);</span><br><span class="line">        });</span><br><span class="line">        <span class="comment">// 认证失败后</span></span><br><span class="line">        loginFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            result.put(<span class="string">"msg"</span>, <span class="string">"登录失败: "</span> + ex.getMessage());</span><br><span class="line">            <span class="comment">// 服务器内部错误 状态码: 500</span></span><br><span class="line">            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">            resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(json);</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> loginFilter;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置安全</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 放行资源</span></span><br><span class="line">                .antMatchers(<span class="string">"/captcha/**"</span>, <span class="string">"/index"</span>, <span class="string">"/login"</span>,<span class="string">"/code"</span>).permitAll()</span><br><span class="line">                <span class="comment">// 所有请求都需要认证</span></span><br><span class="line">                .anyRequest().authenticated().and().formLogin()</span><br><span class="line">                <span class="comment">// 使用自定义登录页面</span></span><br><span class="line">                .loginPage(<span class="string">"/login"</span>)</span><br><span class="line">                <span class="comment">// 退出</span></span><br><span class="line">                .and()</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            	<span class="comment">// 认证异常的处理 </span></span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, ex) -&gt; {</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"请认证之后再去处理...."</span>);</span><br><span class="line">                    result.put(<span class="string">"status"</span>, HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(json);</span><br><span class="line">                })</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">                .and()</span><br><span class="line">                .logout().logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                <span class="comment">// 退出成功后</span></span><br><span class="line">                .logoutSuccessHandler((req, resp, auth) -&gt; {</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"注销成功"</span>);</span><br><span class="line">                    result.put(<span class="string">"authentication"</span>, auth.getPrincipal());</span><br><span class="line">                    resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                    resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(json);</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 禁用跨站</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">        <span class="comment">// at: 用在某个 filter 替换过滤器链中哪个 filter</span></span><br><span class="line">        <span class="comment">// before: 放在过滤器链中那个 filter 之前</span></span><br><span class="line">        <span class="comment">// after: 放在过滤器链中那个 filter 之后</span></span><br><span class="line">        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>前端页面</p>
                  <figure class="highlight html">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><hanla></hanla>登录<hanla></hanla><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@{/login}"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        用户名: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        密码: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        验证码: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"code"</span>/&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">"@{/code}"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登录"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">输入错误的验证码</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/2eaca577ec19459ea6857854cf6f6247.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
              </ul>
            </li>
            <li>
              <p>前后端分离的验证码认证</p>
              <ul>
                <li>
                  <p>生成验证码控制器</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.Producer;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.codec.binary.Base64;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FastByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SplitCaptchaController</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Producer producer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SplitCaptchaController</span><span class="params">(<span class="keyword">final</span> Producer producer)</span> {</span><br><span class="line">        <span class="built_in">this</span>.producer = producer;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@GetMapping("/split/code")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getVerifyCode</span><span class="params">(HttpSession session)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="comment">// 生成验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> producer.createText();</span><br><span class="line">        <span class="comment">// 存储到 session/redis</span></span><br><span class="line">        session.setAttribute(<span class="string">"captcha"</span>, text);</span><br><span class="line">        <span class="comment">// 生成图片</span></span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> producer.createImage(text);</span><br><span class="line">        <span class="type">FastByteArrayOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastByteArrayOutputStream</span>();</span><br><span class="line">        ImageIO.write(image, <span class="string">"jpg"</span>, fos);</span><br><span class="line">        <span class="comment">// 返回 base64</span></span><br><span class="line">        <span class="keyword">return</span> Base64.encodeBase64String(fos.toByteArray());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>base64</code>
                    <hanla></hanla>转图片前缀
                  </p>
                  <figure class="highlight yml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="string">data:image/jpg;base64,</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <table>
                    <thead>
                      <tr>
                        <th align="center"><code>base64</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/9ad2d3418a9d4e92b9b83720ab31805a.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
                <li>
                  <p><code>更换 JSON </code>获取</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.exception.KaptchaNotMatchException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationServiceException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义前后端认证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FORM_KAPTCHA_KEY</span> <span class="operator">=</span> <span class="string">"code"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">kaptchaParameter</span> <span class="operator">=</span> FORM_KAPTCHA_KEY;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKaptchaParameter</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.kaptchaParameter;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKaptchaParameter</span><span class="params">(<span class="keyword">final</span> String kaptchaParameter)</span> {</span><br><span class="line">        <span class="built_in">this</span>.kaptchaParameter = kaptchaParameter;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> {</span><br><span class="line">        log.error(<span class="string">"attemptAuthentication: [{}]"</span>, <span class="string">"Override attemptAuthentication..................................."</span>);</span><br><span class="line">        <span class="comment">// 1. 判断请求方式是否是 POST</span></span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">"POST"</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 2. 判断 数据是否是 JSON 格式</span></span><br><span class="line">        <span class="keyword">if</span> (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 将请求体中的数据进行反序列化</span></span><br><span class="line">                Map&lt;String, String&gt; userInfo = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 先进行验证码校验</span></span><br><span class="line">                <span class="comment">// 获取请求中的验证码</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">parameter</span> <span class="operator">=</span> userInfo.get(getKaptchaParameter());</span><br><span class="line">                <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> userInfo.get(getUsernameParameter());</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userInfo.get(getPasswordParameter());</span><br><span class="line">                <span class="comment">// 获取 session 中的验证码</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">"kaptcha"</span>);</span><br><span class="line">                </span><br><span class="line">                log.error(<span class="string">"username: [{}]"</span>, username);</span><br><span class="line">                log.error(<span class="string">"password: [{}]"</span>, password);</span><br><span class="line">                log.error(<span class="string">"code: [{}]"</span>, code);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 用户输入的验证码和 session 作用域中的都不能为空</span></span><br><span class="line">                <span class="keyword">if</span> (!ObjectUtils.isEmpty(parameter) &amp;&amp; !ObjectUtils.isEmpty(code) &amp;&amp; parameter.equalsIgnoreCase(code)) {</span><br><span class="line">                    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">                    <span class="built_in">this</span>.setDetails(request, authRequest);</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KaptchaNotMatchException</span>(<span class="string">"验证码不匹配"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h4>
          <ul>
            <li>
              <p>认识<hanla></hanla><code>PasswordEncoder</code></p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PasswordEncoder</span> {</span><br><span class="line">    String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">upgradeEncoding</span><span class="params">(String encodedPassword)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <ul>
                <li><code>encode</code>: 用来进行铭文加密的</li>
                <li><code>matches</code>: 用来比较密码的方法</li>
                <li><code>upgradeEncoding</code>: 用来给密码进行升级的方法</li>
              </ul>
            </li>
            <li>
              <p>所有未过期的实现类</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">所有未过期的实现类</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/43cdb0b504d44537a78e86fc91f9ec20.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>密码更新</p>
              <ul>
                <li>
                  <p>实现<hanla></hanla><code>Service</code></p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.entity.Role;</span><br><span class="line"><span class="keyword">import</span> com.example.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsPasswordService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span>, UserDetailsPasswordService {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyUserDetailsService</span><span class="params">(<span class="keyword">final</span> UserMapper userMapper)</span> {</span><br><span class="line">        <span class="built_in">this</span>.userMapper = userMapper;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line">        <span class="comment">// 根据用户名查询用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.findUserByUserName(username);</span><br><span class="line">        <span class="comment">// 如果用户为空</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(user)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">"用户名错误!"</span>);</span><br><span class="line">        <span class="comment">// 查询权限信息</span></span><br><span class="line">        List&lt;Role&gt; roles = userMapper.getRoleByUid(user.getId());</span><br><span class="line">        user.setRoles(roles);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 实现密码更新</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">updatePassword</span><span class="params">(UserDetails user, String newPassword)</span> {</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">updatePassword</span> <span class="operator">=</span> userMapper.updatePassword(user.getUsername(), newPassword);</span><br><span class="line">        <span class="keyword">if</span> (updatePassword == <span class="number">1</span>) {</span><br><span class="line">            ((User) user).setPassword(newPassword);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>UserMapper</code></p>
                  <figure class="highlight xml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.mapper.UserMapper"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- User findUserByUserName(String username); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findUserByUserName"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        select *</span><br><span class="line">        from user</span><br><span class="line">        where username = #{username}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- List&lt;Role&gt; getRoleByUid(Integer uid); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRoleByUid"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select r.id, r.name, r.name_zh</span><br><span class="line">        from role r,</span><br><span class="line">             user_role ur</span><br><span class="line">        where r.id = ur.uid</span><br><span class="line">          and ur.uid = #{uid}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--  Integer updatePassword(@Param("username") String username,@Param("password") String password);--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updatePassword"</span>&gt;</span></span><br><span class="line">        update `user`</span><br><span class="line">        set password = #{password}</span><br><span class="line">        where username = #{username}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>更新密码是在原密码上直接更新用户密码的加密方式</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center"><code>{noop}(明文) =&gt; {bcrypt}<hanla></hanla>加密方式</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/811df4fde24445da9e7a8057976f92d6.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="RemaemberMe"><a href="#RemaemberMe" class="headerlink" title="RemaemberMe"></a>RemaemberMe</h4>
          <ul>
            <li>
              <p>配置类中添加</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line"></span><br><span class="line">        .and().formLogin()</span><br><span class="line">        <span class="comment">// 记住我</span></span><br><span class="line">        .and().rememberMe()</span><br><span class="line"></span><br><span class="line">        .and().csrf().disable();</span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>自定义登录认证</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">开启后</th>
                    <th align="center">根据源码分析,<hanla></hanla>在自定义页面上实现如下即可</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/8d23f51d42114752addb99284eaf3f28.png" alt="在这里插入图片描述"></td>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/a64693b0b53d43cbafeb2e1c2465a8eb.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>原理分析</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">勾选后,<hanla></hanla>传递参数<hanla></hanla><code>remember-me: on</code></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/852266b202814ac394004cca31ccdc9a.png"></td>
                  </tr>
                </tbody>
              </table>
              <table>
                <thead>
                  <tr>
                    <th align="center"><code>RememberMeAuthenticationFilter</code>
                      <hanla></hanla>源码分析
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/5c831c7e68604b609c202a570fb39ecc.png"></td>
                  </tr>
                </tbody>
              </table>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">// RememberMeAuthenticationFilter 中的核心<hanla></hanla></span></span><br><span class="line"><span class="type">Authentication</span> <span class="variable">rememberMeAuth</span> <span class="operator">=</span> <span class="built_in">this</span>.rememberMeServices.autoLogin(request, response);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">// 核心 autologin(会话超时后<hanla></hanla>(一段时间过期))<hanla></hanla>触发<hanla></hanla>autologin </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Authentication <span class="title function_">autoLogin</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">rememberMeCookie</span> <span class="operator">=</span> <span class="built_in">this</span>.extractRememberMeCookie(request);</span><br><span class="line">        <span class="keyword">if</span> (rememberMeCookie == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="built_in">this</span>.logger.debug(<span class="string">"Remember-me cookie detected"</span>);</span><br><span class="line">            <span class="keyword">if</span> (rememberMeCookie.length() == <span class="number">0</span>) {</span><br><span class="line">                <span class="built_in">this</span>.logger.debug(<span class="string">"Cookie was empty"</span>);</span><br><span class="line">                <span class="built_in">this</span>.cancelCookie(request, response);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    String[] cookieTokens = <span class="built_in">this</span>.decodeCookie(rememberMeCookie);</span><br><span class="line">                    <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.processAutoLoginCookie(cookieTokens, request, response);</span><br><span class="line">                    <span class="built_in">this</span>.userDetailsChecker.check(user);</span><br><span class="line">                    <span class="built_in">this</span>.logger.debug(<span class="string">"Remember-me cookie accepted"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.createSuccessfulAuthentication(request, user);</span><br><span class="line">                } <span class="keyword">catch</span> (CookieTheftException var6) {</span><br><span class="line">                    <span class="built_in">this</span>.cancelCookie(request, response);</span><br><span class="line">                    <span class="keyword">throw</span> var6;</span><br><span class="line">                } <span class="keyword">catch</span> (UsernameNotFoundException var7) {</span><br><span class="line">                    <span class="built_in">this</span>.logger.debug(<span class="string">"Remember-me login was valid but corresponding user not found."</span>, var7);</span><br><span class="line">                } <span class="keyword">catch</span> (InvalidCookieException var8) {</span><br><span class="line">                    <span class="built_in">this</span>.logger.debug(<span class="string">"Invalid remember-me cookie: "</span> + var8.getMessage());</span><br><span class="line">                } <span class="keyword">catch</span> (AccountStatusException var9) {</span><br><span class="line">                    <span class="built_in">this</span>.logger.debug(<span class="string">"Invalid UserDetails: "</span> + var9.getMessage());</span><br><span class="line">                } <span class="keyword">catch</span> (RememberMeAuthenticationException var10) {</span><br><span class="line">                    <span class="built_in">this</span>.logger.debug(var10.getMessage());</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.cancelCookie(request, response);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center"><code>cookie: remember-me</code></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/46083555dda043d3b79f4cfcdecb1df9.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>总结</p>
              <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
                <p>当用户通过用户名<hanla></hanla>/<hanla></hanla>密码的形式登录成功后，系统会根据用户的用户名、密码以及令牌的过期时间计算出一个签名，这个签名使用<hanla></hanla><code>MD5</code>
                  <hanla></hanla>消息摘要算法生成，是不可逆的。然后再将用户名，令牌过期时间以及签名拼接成一个字符串，中间用<code>:</code>
                  <hanla></hanla>隔开，对拼接好的字符串进行<hanla></hanla><code>Base64</code>
                  <hanla></hanla>编码，然后再将编码后的结果返回到前端，也就是我们在浏览器中看到的令牌。当会话过期后，访问系统资源时会自动携带<hanla></hanla><code>cookie</code>
                  <hanla></hanla>中的令牌，服务端拿到<hanla></hanla><code>cookie</code>
                  <hanla></hanla>中的令牌后，先进行<hanla></hanla><code>Base64</code>
                  <hanla></hanla>解码，如果没有过期，则根据令牌中的用户名和查询出用户信息，接着在计算出一个签名和令牌中的签名进行对比，如果一致，表示会牌是合法令牌，自动登录成功，否则自动登录失败
                </p>
              </div>
            </li>
            <li>
              <p>原理图总结</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">总结</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/514d2531390743708345f959c010fe36.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>配置持久化令牌</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">// 前提是整合: mybatis </span></span><br><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.service.MyUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.rememberme.JdbcTokenRepositoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(DataSource dataSource, <span class="keyword">final</span> MyUserDetailsService myUserDetailsService)</span> {</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">        <span class="built_in">this</span>.myUserDetailsService = myUserDetailsService;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自定义  AuthenticationManager 推荐 并没有在工厂在暴露出来</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        log.error(<span class="string">"自定义 AuthenticationManager: "</span> + builder);</span><br><span class="line">        builder.userDetailsService(myUserDetailsService);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 作用: 用来将自定义 AuthenticationManager 在工厂中进行暴露 可以在任意位置注入</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated().and().formLogin()</span><br><span class="line">            </span><br><span class="line">                <span class="comment">// 记住我</span></span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">            	<span class="comment">// rememberMe 持久化</span></span><br><span class="line">            	.tokenRepository(persistentTokenRepository())</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PersistentTokenRepository <span class="title function_">persistentTokenRepository</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">jdbcTokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        <span class="comment">// 第一次启动时创建表结构<hanla></hanla>(true) 第二次: false</span></span><br><span class="line">        jdbcTokenRepository.setCreateTableOnStartup(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <ul>
                <li>
                  <p>错误</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">错误原因:<code>jdbcTokenRepository.setCreateTableOnStartup(true); 第二次启动时数据库中已经存在表结构</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/105da5e5810c49adad1fb511eb141255.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
                <li>
                  <p>创建的表</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center"><code>rememberMe<hanla></hanla>实现持久化</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/2187f2d77516464891c98972aab0db89.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="自定义记住我-前后端分离实现"><a href="#自定义记住我-前后端分离实现" class="headerlink" title="自定义记住我(前后端分离实现)"></a>自定义记住我<hanla></hanla>(前后端分离实现)</h4>
          <ul>
            <li>
              <p>传统<hanla></hanla><code>WEB</code></p>
              <ul>
                <li>
                  <p>配置中开启<code>记住我</code></p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/login"</span>).permitAll()</span><br><span class="line">        .anyRequest().authenticated().and()</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginPage(<span class="string">"/login"</span>)</span><br><span class="line">        .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">        <span class="comment">// 登录成功后的跳转</span></span><br><span class="line">        .defaultSuccessUrl(<span class="string">"/test"</span>, <span class="literal">true</span>)</span><br><span class="line">        .and()</span><br><span class="line">        <span class="comment">// 记住我</span></span><br><span class="line">        .rememberMe()</span><br><span class="line">        <span class="comment">// remember 的持久化</span></span><br><span class="line">        .tokenRepository(persistentTokenRepository())</span><br><span class="line">        .and().csrf().disable();</span><br><span class="line">}</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>checkbox</code>
                    <hanla></hanla>的值
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="comment">// 源码<hanla></hanla></span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">rememberMeRequested</span><span class="params">(HttpServletRequest request, String parameter)</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.alwaysRemember) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getParameter(parameter);</span><br><span class="line">            <span class="keyword">if</span> (paramValue == <span class="literal">null</span> || !paramValue.equalsIgnoreCase(<span class="string">"true"</span>) &amp;&amp; !paramValue.equalsIgnoreCase(<span class="string">"on"</span>) &amp;&amp; !paramValue.equalsIgnoreCase(<span class="string">"yes"</span>) &amp;&amp; !paramValue.equals(<span class="string">"1"</span>)) {</span><br><span class="line">                <span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">"Did not send remember-me cookie (principal did not set parameter '%s')"</span>, parameter));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>页面定义</p>
                  <figure class="highlight html">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><hanla></hanla>登录<hanla></hanla><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@{/login}"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        用户名: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        密码: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        记住我: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"remember-me"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登录"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>点击<code>记住我</code>登录,<hanla></hanla>生成<hanla></hanla><code>cookie</code></p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center"><code>cookie</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/7ae574d0dfa84895b280a88aeb9b6a6f.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
              </ul>
            </li>
            <li>
              <p>前后端分离</p>
              <ul>
                <li>
                  <p>创建一个前后端分离的项目</p>
                </li>
                <li>
                  <p><code>rememberMeRequested =&gt; AbstractRememberMeServices(类中)</code></p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">rememberMeRequested</span><span class="params">(HttpServletRequest request, String parameter)</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.alwaysRemember) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getParameter(parameter);</span><br><span class="line">            <span class="keyword">if</span> (paramValue == <span class="literal">null</span> || !paramValue.equalsIgnoreCase(<span class="string">"true"</span>) &amp;&amp; !paramValue.equalsIgnoreCase(<span class="string">"on"</span>) &amp;&amp; !paramValue.equalsIgnoreCase(<span class="string">"yes"</span>) &amp;&amp; !paramValue.equals(<span class="string">"1"</span>)) {</span><br><span class="line">                <span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">"Did not send remember-me cookie (principal did not set parameter '%s')"</span>, parameter));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>security</code>
                    <hanla></hanla>配置类
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.filter.LoginFilter;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.RememberMeServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.rememberme.InMemoryTokenRepositoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="comment">// 使用内存中的用户认证</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">"root"</span>).password(<span class="string">"{noop}123"</span>).roles(<span class="string">"admin"</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自定义 filter 交给工厂管理</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginFilter <span class="title function_">loginFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">LoginFilter</span> <span class="variable">loginFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginFilter</span>();</span><br><span class="line">        <span class="comment">// 指定认证的 url</span></span><br><span class="line">        loginFilter.setFilterProcessesUrl(<span class="string">"/doLogin"</span>);</span><br><span class="line">        <span class="comment">// 接受指定的 json 用户名 key</span></span><br><span class="line">        loginFilter.setUsernameParameter(<span class="string">"username"</span>);</span><br><span class="line">        <span class="comment">// 接受指定的 json 密码 key</span></span><br><span class="line">        loginFilter.setPasswordParameter(<span class="string">"password"</span>);</span><br><span class="line">        <span class="comment">// 注入 authenticationManager</span></span><br><span class="line">        loginFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 设置认证成功后时使用自定义 rememberMeServices</span></span><br><span class="line">        loginFilter.setRememberMeServices(rememberMeServices());</span><br><span class="line">        <span class="comment">// 认证成功后</span></span><br><span class="line">        loginFilter.setAuthenticationSuccessHandler((req, resp, auth) -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            result.put(<span class="string">"msg"</span>, <span class="string">"登录成功"</span>);</span><br><span class="line">            <span class="comment">// 状态码: 200</span></span><br><span class="line">            resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">            result.put(<span class="string">"authentication"</span>, auth);</span><br><span class="line">            resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(json);</span><br><span class="line">        });</span><br><span class="line">        <span class="comment">// 认证失败后</span></span><br><span class="line">        loginFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            result.put(<span class="string">"msg"</span>, <span class="string">"登录失败: "</span> + ex.getMessage());</span><br><span class="line">            <span class="comment">// 服务器内部错误 状态码: 500</span></span><br><span class="line">            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">            resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(json);</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> loginFilter;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置安全</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 所有请求都需要认证</span></span><br><span class="line">                .anyRequest().authenticated().and().formLogin()</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 1. 认证成功保存记住我 cookie 到客户端  2. 只有 cookie 写入到客户端成功才能实现自动登录功能</span></span><br><span class="line">                .and().rememberMe()</span><br><span class="line">                <span class="comment">// 设置自动登录使用那个 rememberMeServices</span></span><br><span class="line">                .rememberMeServices(rememberMeServices())</span><br><span class="line">                <span class="comment">// 退出</span></span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, ex) -&gt; {</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"请认证之后再去处理...."</span>);</span><br><span class="line">                    result.put(<span class="string">"status"</span>, HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(json);</span><br><span class="line">                })</span><br><span class="line">                .and()</span><br><span class="line">                .logout().logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                <span class="comment">// 退出成功后</span></span><br><span class="line">                .logoutSuccessHandler((req, resp, auth) -&gt; {</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"注销成功"</span>);</span><br><span class="line">                    result.put(<span class="string">"authentication"</span>, auth.getPrincipal());</span><br><span class="line">                    resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                    resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(json);</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 禁用跨站</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">        <span class="comment">// at: 用在某个 filter 替换过滤器链中哪个 filter</span></span><br><span class="line">        <span class="comment">// before: 放在过滤器链中那个 filter 之前</span></span><br><span class="line">        <span class="comment">// after: 放在过滤器链中那个 filter 之后</span></span><br><span class="line">        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RememberMeServices <span class="title function_">rememberMeServices</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPersistentTokenBasedRememberMeServices</span>(UUID.randomUUID().toString(), userDetailsService(), <span class="keyword">new</span> <span class="title class_">InMemoryTokenRepositoryImpl</span>());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>自定义过滤器</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.config.MyPersistentTokenBasedRememberMeServices;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationServiceException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.RememberMeServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.rememberme.AbstractRememberMeServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义前后端认证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> {</span><br><span class="line">        log.error(<span class="string">"attemptAuthentication: [{}]"</span>, <span class="string">"Override attemptAuthentication..................................."</span>);</span><br><span class="line">        <span class="comment">// 1. 判断请求方式是否是 POST</span></span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">"POST"</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 2. 判断 数据是否是 JSON 格式</span></span><br><span class="line">        <span class="keyword">if</span> (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 将请求体中的数据进行反序列化</span></span><br><span class="line">                Map&lt;String, String&gt; userInfo = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);</span><br><span class="line">                <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> userInfo.get(getUsernameParameter());</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userInfo.get(getPasswordParameter());</span><br><span class="line">                <span class="comment">// 记住我 AbstractRememberMeServices.DEFAULT_PARAMETER = remember-me</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">rememberValue</span> <span class="operator">=</span> userInfo.get(AbstractRememberMeServices.DEFAULT_PARAMETER);</span><br><span class="line">                <span class="keyword">if</span> (!ObjectUtils.isEmpty(rememberValue)) {</span><br><span class="line">                    request.setAttribute(AbstractRememberMeServices.DEFAULT_PARAMETER, rememberValue);</span><br><span class="line">                }</span><br><span class="line">                log.error(<span class="string">"username: [{}]"</span>, username);</span><br><span class="line">                log.error(<span class="string">"password: [{}]"</span>, password);</span><br><span class="line">                log.error(<span class="string">"remember: [{}]"</span>, rememberValue);</span><br><span class="line">                <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">                <span class="built_in">this</span>.setDetails(request, authRequest);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 如果不是 JSON 格式数据,<hanla></hanla>则调用传统方式进行认证</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>PersistentTokenBasedRememberMeServices</code>
                    <hanla></hanla>类集成重写
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.log.LogMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenBasedRememberMeServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPersistentTokenBasedRememberMeServices</span> <span class="keyword">extends</span> <span class="title class_">PersistentTokenBasedRememberMeServices</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyPersistentTokenBasedRememberMeServices</span><span class="params">(String key, UserDetailsService userDetailsService, PersistentTokenRepository tokenRepository)</span> {</span><br><span class="line">        <span class="built_in">super</span>(key, userDetailsService, tokenRepository);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义获取 remember-me 方式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">rememberMeRequested</span><span class="params">(HttpServletRequest request, String parameter)</span> {</span><br><span class="line">        log.info(<span class="string">"parameter: [{}]"</span>, parameter);</span><br><span class="line">        <span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getAttribute(parameter).toString();</span><br><span class="line">        <span class="keyword">if</span> (paramValue == <span class="literal">null</span> || !paramValue.equalsIgnoreCase(<span class="string">"true"</span>) &amp;&amp; !paramValue.equalsIgnoreCase(<span class="string">"on"</span>) &amp;&amp; !paramValue.equalsIgnoreCase(<span class="string">"yes"</span>) &amp;&amp; !paramValue.equals(<span class="string">"1"</span>)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>源文件</p>
                  <blockquote>
                    <p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gitee.com/coder-itl/spring-security/tree/remember-me">https://gitee.com/coder-itl/spring-security/tree/remember-me</a></p>
                  </blockquote>
                </li>
                <li>
                  <p>测试</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">配置<hanla></hanla><code>session</code>
                          <hanla></hanla>过期时间
                        </th>
                        <th align="center"><code>remember-me</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/9d04a8235b9b40b381e51bcbd6cbf06e.png"></td>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/145639fe3e5546c3a9fa870d371f588d.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
                <li>
                  <p>必须传递<hanla></hanla><code>remember-me</code>?</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">如何优雅处理<hanla></hanla><code>remember-me</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/430e159e8c3b46e080c841e5507212b2.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h4>
          <h5 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h5>
          <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
            <p>当浏览器调用接口登录成功后，服务端会和浏览器之间建立一个会话<hanla></hanla>(<code>session</code>)<hanla></hanla>浏览器在每次发送请求时都会携带一个<hanla></hanla><code>SessionId</code>,<hanla></hanla>服务端则根据这个<hanla></hanla><code>SessionId</code>
              <hanla></hanla>来判断用户身份。当浏览器关闭后,<hanla></hanla>服务端的<hanla></hanla><code>Session</code>
              <hanla></hanla>并不会自动销毁，需要开发者手动在服务端调用<hanla></hanla><code>Session</code>
              <hanla></hanla>销毁方法，或者等<hanla></hanla><code>Session</code>
              <hanla></hanla>过期时间到了自动销毁。在<hanla></hanla><code>Spring Security</code>
              <hanla></hanla>中,<hanla></hanla>与<hanla></hanla><code>HttpSession</code>
              <hanla></hanla>相关的功能由<hanla></hanla><code>SessionManagementFilter</code>
              <hanla></hanla>和<hanla></hanla><code>Session AutheaticationStrateey</code>
              <hanla></hanla>接口来处理,<code>SessionManagomentFiter</code>
              <hanla></hanla>过滤器将<hanla></hanla><code>session</code>
              <hanla></hanla>相关操作委托给<hanla></hanla><code>SessionAuthenticationStrategy</code>
              <hanla></hanla>接口去完成。
            </p>
          </div>
          <h5 id="会话并发管理"><a href="#会话并发管理" class="headerlink" title="会话并发管理"></a>会话并发管理</h5>
          <ul>
            <li>
              <p>简介</p>
              <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
                <p>会话并发管理就是指在当前系统中，同一个用户可以同时创建多少个会话，如果一个设备对应一个会话，那么也可以简单理解为同一个用户可以同时在多少台设备上进行登录。默认情况下，同一用户在多少台设备上登录并没有限制，不过开发者可以在<hanla></hanla><code>spring security</code>
                  <hanla></hanla>中对此进行配置
                </p>
              </div>
            </li>
            <li>
              <p>会话配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.session.HttpSessionEventPublisher;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and().csrf().disable()</span><br><span class="line">                <span class="comment">// 开启会话管理</span></span><br><span class="line">                .sessionManagement()</span><br><span class="line">                <span class="comment">// 允许会话最大并发只能一个客户端 设置会话的并发数</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)</span><br><span class="line">        ;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpSessionEventPublisher <span class="title function_">httpSessionEventPublisher</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpSessionEventPublisher</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <ul>
                <li>
                  <p>访问测试</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">第二个访问会导致第一个访问失效</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/71dcb726d3a241e388d09102d5747cf7.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
                <li>
                  <p>说明</p>
                  <ol>
                    <li><code>sessionManagement()</code>
                      <hanla></hanla>用来开启会话管理，<code>maximumSessions</code>
                      <hanla></hanla>指定会话的并发数
                    </li>
                    <li><code>HttpSessionEventPublisher</code>
                      <hanla></hanla>提供一个<hanla></hanla><code>Http SessionEventPublishor</code>
                      <hanla></hanla>实例，<code>SpringSecurity</code>
                      <hanla></hanla>中通过一个<hanla></hanla><code>Map</code>
                      <hanla></hanla>集合来维护当前的<hanla></hanla><code>HttpSession</code>
                      <hanla></hanla>记录,<hanla></hanla>进而实现会话的并发管理。当用户登录成功时,<hanla></hanla>就像集合中添加一条<hanla></hanla><code>Http Session</code>
                      <hanla></hanla>记录，当会话销毁时，就从集合中移除一条<hanla></hanla><code>HttpSession</code>
                      <hanla></hanla>记录，<code>HttpSessionEventPublisher</code>
                      <hanla></hanla>实现了<hanla></hanla><code>Fttp SessionListener</code>
                      <hanla></hanla>接口,<hanla></hanla>可以监听到<hanla></hanla><code>HttpSession</code>
                      <hanla></hanla>的创建和销毁事件，并将<hanla></hanla><code>Fltp Session</code>
                      <hanla></hanla>的创建<hanla></hanla>/<hanla></hanla>销毁事件发布出去，这样，当有<hanla></hanla><code>HttpSession</code>
                      <hanla></hanla>销毁时，<code>SpringSecurity</code>
                      <hanla></hanla>就可以感知到该事件了。
                    </li>
                  </ol>
                </li>
              </ul>
            </li>
          </ul>
          <h5 id="传统WEB开发处理失效"><a href="#传统WEB开发处理失效" class="headerlink" title="传统WEB开发处理失效"></a>传统<hanla></hanla>WEB<hanla></hanla>开发处理失效</h5>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.session.HttpSessionEventPublisher;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and().csrf().disable()</span><br><span class="line">                <span class="comment">// 开启会话管理</span></span><br><span class="line">                .sessionManagement()</span><br><span class="line">                <span class="comment">// 允许会话最大并发只能一个客户端 设置会话的并发数</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 传统 web 失效处理 当用户被挤下线之后跳转路径</span></span><br><span class="line">                .expiredUrl(<span class="string">"/login"</span>)</span><br><span class="line">        ;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpSessionEventPublisher <span class="title function_">httpSessionEventPublisher</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpSessionEventPublisher</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h5 id="前后端分离失效处理"><a href="#前后端分离失效处理" class="headerlink" title="前后端分离失效处理"></a>前后端分离失效处理</h5>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.session.HttpSessionEventPublisher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and().csrf().disable()</span><br><span class="line">                <span class="comment">// 开启会话管理</span></span><br><span class="line">                .sessionManagement()</span><br><span class="line">                <span class="comment">// 允许会话最大并发只能一个客户端 设置会话的并发数</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 前后端分离</span></span><br><span class="line">                .expiredSessionStrategy(event -&gt; {</span><br><span class="line">                    <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">                    response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"status"</span>, <span class="number">500</span>);</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"当前会话已经失效,<hanla></hanla>请重新登录!"</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    response.getWriter().println(json);</span><br><span class="line">                    response.flushBuffer();</span><br><span class="line">                })</span><br><span class="line">        ;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpSessionEventPublisher <span class="title function_">httpSessionEventPublisher</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpSessionEventPublisher</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>访问测试</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">前后分离会话失效处理</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/28736bd3b9e14c5c919839d7c42832ba.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>
          <h5 id="禁止再次登录"><a href="#禁止再次登录" class="headerlink" title="禁止再次登录"></a>禁止再次登录</h5>
          <ul>
            <li>
              <p>即: <code>只允许在一台设备登录,<hanla></hanla>只有登录设备主动退出后,<hanla></hanla>其他客户端才允许登录</code></p>
            </li>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="comment">// 开启会话管理</span></span><br><span class="line">.sessionManagement()</span><br><span class="line">    <span class="comment">// 允许会话最大并发只能一个客户端 设置会话的并发数</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 登录之后禁止再次登录</span></span><br><span class="line">    .maxSessionsPreventsLogin(<span class="literal">true</span>)</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center">只允许一台客户端登录</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/1dbd89f395ff49f8973fd407c3db2f3e.png" style="zoom:67%;"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>
          <h5 id="集群会话共享解决方案"><a href="#集群会话共享解决方案" class="headerlink" title="集群会话共享解决方案"></a>集群会话共享解决方案</h5>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.session.HttpSessionEventPublisher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.session.FindByIndexNameSessionRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.session.security.SpringSessionBackedSessionRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FindByIndexNameSessionRepository findByIndexNameSessionRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(FindByIndexNameSessionRepository findByIndexNameSessionRepository)</span> {</span><br><span class="line">        <span class="built_in">this</span>.findByIndexNameSessionRepository = findByIndexNameSessionRepository;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and().logout()</span><br><span class="line">                .and().csrf().disable()</span><br><span class="line">                <span class="comment">// 开启会话管理</span></span><br><span class="line">                .sessionManagement()</span><br><span class="line">                <span class="comment">// 允许会话最大并发只能一个客户端 设置会话的并发数</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)</span><br><span class="line">                <span class="comment">// 登录之后禁止再次登录</span></span><br><span class="line">                .maxSessionsPreventsLogin(<span class="literal">true</span>)</span><br><span class="line">                <span class="comment">// 将 session 交给谁管理</span></span><br><span class="line">                .sessionRegistry(sessionRegistry())</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 前后端分离</span></span><br><span class="line">                .expiredSessionStrategy(event -&gt; {</span><br><span class="line">                    <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">                    response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"status"</span>, <span class="number">500</span>);</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"当前会话已经失效,<hanla></hanla>请重新登录!"</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    response.getWriter().println(json);</span><br><span class="line">                    response.flushBuffer();</span><br><span class="line">                })</span><br><span class="line">        ;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 创建 session 同步到 redis 中方案</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SpringSessionBackedSessionRegistry <span class="title function_">sessionRegistry</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringSessionBackedSessionRegistry</span>(findByIndexNameSessionRepository);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>创建项目集群</p>
              <ul>
                <li>
                  <p>拷贝并修改端口</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">拷贝<hanla></hanla>(①)</th>
                        <th align="center">添加<hanla></hanla><code>VM</code>②</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/5d1ac25b65354764844b2280323fed06.png" alt="在这里插入图片描述"></td>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/01861dd06b204b9d9c1816bc875562c5.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
                <li>
                  <p>修改端口</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">③ 修改端口<code>-Dserver.port=8081</code></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/20a804643c934d678daf91b9935847d7.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
              </ul>
            </li>
            <li>
              <p>连接<hanla></hanla><code>redis</code>
                <hanla></hanla>客户端，查看访问之后生成的<code>键</code>信息
              </p>
              <table>
                <thead>
                  <tr>
                    <th align="center">不同客户端访问测试<hanla></hanla>(注意端口)</th>
                    <th align="center">集群会话记录</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/7fba8ddd04ef43c98ce40527046ede40.png"></td>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/b98b0da6a72842588356946338192f57.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>
          <h4 id="CSRF-漏洞保护"><a href="#CSRF-漏洞保护" class="headerlink" title="CSRF 漏洞保护"></a>CSRF 漏洞保护</h4>
          <h5 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h5>
          <ul>
            <li><code>CSRF(Cross-Site Request Forgery 跨站请求伪造)</code>,<hanla></hanla>也可以称为一键式攻击<hanla></hanla>(<code>one-click-attack</code>)，通常缩写为<hanla></hanla><code>CSRF/XSRF</code></li>
            <li><code>CSRF</code>
              <hanla></hanla>攻击是一种挟持用户在当前已登录的浏览器上发送恶意请求的攻击方法。相对于<hanla></hanla><code>XSS</code>
              <hanla></hanla>利用用户对指定网站的信任，<code>CSRF</code>
              <hanla></hanla>则是利用网站对用户网页浏览器的信任。简单来说，<code>CSRF</code>
              <hanla></hanla>是攻击者通过一些技术手段欺骗用户的浏览器,<hanla></hanla>去访问一个用户层级认证过的网站并执行恶意请求，例如发送右键、发送消息，甚至财产操作<hanla></hanla>(如转账和购买商品)。由于客户端<hanla></hanla>(浏览器)<hanla></hanla>已经在该网站上认证过，所以该网站会认为是真正用户在操作而执行的请求<hanla></hanla>(实际上这个并非的本意)
            </li>
          </ul>
          <h5 id="开启-CSRF-防御"><a href="#开启-CSRF-防御" class="headerlink" title="开启 CSRF  防御"></a>开启 CSRF 防御</h5>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line">.csrf();</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>查看网页源码</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">携带<hanla></hanla><code>CSRF</code>
                      <hanla></hanla>令牌
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/dbee3a234a634690aff5403ca4875ae2.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>
          <h5 id="传统WEB开发中使用CSRF"><a href="#传统WEB开发中使用CSRF" class="headerlink" title="传统WEB开发中使用CSRF"></a>传统<hanla></hanla>WEB<hanla></hanla>开发中使用<hanla></hanla>CSRF</h5>
          <ul>
            <li>
              <p>传统<hanla></hanla><code>web</code>
                <hanla></hanla>只需要在配置类中开启<hanla></hanla><code>csrf</code>
                <hanla></hanla>即可
              </p>
            </li>
            <li>
              <p>开启<hanla></hanla><code>CSRF</code>
                <hanla></hanla>防御后会自动在提交的表单中加入如下代码，需要在开启之后手动加入如下代码，并随着请求提交。获取服务端令牌方式如下
              </p>
              <figure class="highlight html">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">th:name</span>=<span class="string">"${_csrf.parameterName}"</span> <span class="attr">th:value</span>=<span class="string">"${_csrf.token}"</span>&gt;</span></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h5 id="前后分离使用-CSRF"><a href="#前后分离使用-CSRF" class="headerlink" title="前后分离使用 CSRF"></a>前后分离使用 CSRF</h5>
          <ul>
            <li>
              <p>前后端分离开发时,<hanla></hanla>只需要将生成的<hanla></hanla><code>csrf</code>
                <hanla></hanla>放入到<hanla></hanla><code>cookie</code>
                <hanla></hanla>中,<hanla></hanla>并在请求时获取<hanla></hanla><code>cookie</code>
                <hanla></hanla>中令牌信息进行提交即可。
              </p>
            </li>
            <li>
              <p>访问<code>前后端分离下的<hanla></hanla>login</code>，使其产生<hanla></hanla><code>cookie</code></p>
              <table>
                <thead>
                  <tr>
                    <th align="center">生成<hanla></hanla><code>XSRF-TOKEN</code>
                      <hanla></hanla>的<hanla></hanla><code>cookie</code>
                    </th>
                    <th align="center">认证未通过</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/62b1a8004b984b54afc216adfed81ffb.png"></td>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/c72f45d5243e4ec197d055bc29e7ea96.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="comment">// 使用内存中的用户认证</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">"root"</span>).password(<span class="string">"{noop}root"</span>).roles(<span class="string">"admin"</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自定义 filter 交给工厂管理</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginFilter <span class="title function_">loginFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">LoginFilter</span> <span class="variable">loginFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginFilter</span>();</span><br><span class="line">        <span class="comment">// 指定认证的 url</span></span><br><span class="line">        loginFilter.setFilterProcessesUrl(<span class="string">"/login"</span>);</span><br><span class="line">        <span class="comment">// 接受指定的 json 用户名 key</span></span><br><span class="line">        loginFilter.setUsernameParameter(<span class="string">"username"</span>);</span><br><span class="line">        <span class="comment">// 接受指定的 json 密码 key</span></span><br><span class="line">        loginFilter.setPasswordParameter(<span class="string">"password"</span>);</span><br><span class="line">        <span class="comment">// 注入 authenticationManager</span></span><br><span class="line">        loginFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="comment">// 认证成功后</span></span><br><span class="line">        loginFilter.setAuthenticationSuccessHandler((req, resp, auth) -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            result.put(<span class="string">"msg"</span>, <span class="string">"登录成功"</span>);</span><br><span class="line">            <span class="comment">// 状态码: 200</span></span><br><span class="line">            resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">            result.put(<span class="string">"authentication"</span>, auth);</span><br><span class="line">            resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(json);</span><br><span class="line">        });</span><br><span class="line">        <span class="comment">// 认证失败后</span></span><br><span class="line">        loginFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            result.put(<span class="string">"msg"</span>, <span class="string">"登录失败: "</span> + ex.getMessage());</span><br><span class="line">            <span class="comment">// 服务器内部错误 状态码: 500</span></span><br><span class="line">            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">            resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(json);</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> loginFilter;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置安全</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 所有请求都需要认证</span></span><br><span class="line">                .anyRequest().authenticated().and().formLogin()</span><br><span class="line">                <span class="comment">// 退出</span></span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, ex) -&gt; {</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"请认证之后再去处理...."</span>);</span><br><span class="line">                    result.put(<span class="string">"status"</span>, HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(json);</span><br><span class="line">                })</span><br><span class="line">                .and()</span><br><span class="line">                .logout().logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                <span class="comment">// 退出成功后</span></span><br><span class="line">                .logoutSuccessHandler((req, resp, auth) -&gt; {</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">"msg"</span>, <span class="string">"注销成功"</span>);</span><br><span class="line">                    result.put(<span class="string">"authentication"</span>, auth.getPrincipal());</span><br><span class="line">                    resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                    resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(json);</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 开启跨站: 将令牌保存到 cookie 中并允许 cookie 被前端获取</span></span><br><span class="line">                .and().csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());</span><br><span class="line">        <span class="comment">// at: 用在某个 filter 替换过滤器链中哪个 filter</span></span><br><span class="line">        <span class="comment">// before: 放在过滤器链中那个 filter 之前</span></span><br><span class="line">        <span class="comment">// after: 放在过滤器链中那个 filter 之后</span></span><br><span class="line">        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>控制器</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> {</span><br><span class="line">    <span class="meta">@PostMapping("/index")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index ok..."</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>发送请求携带令牌即可</p>
              <ul>
                <li>
                  <p>请求参数中携带令牌</p>
                  <figure class="highlight json">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">key<span class="punctuation">:</span> _csrf</span><br><span class="line">value<span class="punctuation">:</span> <span class="string">"xxx"</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>请求头中携带令牌</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="comment">// 前后端分离认证时，初次访问 /login,<hanla></hanla>会生成一个 cookie,<hanla></hanla>获取他得值，将该值以键 `X-XSRF-TOKEN',<hanla></hanla>值为初次访问时生成的 cookie</span></span><br><span class="line">X-XSRF-TOKEN: value</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">详细过程</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://i.328888.xyz/2023/03/27/iUudXF.gif"></td>
                      </tr>
                    </tbody>
                  </table>
                  <blockquote>
                    <p>疑问: 那如何直接在第一次就可以登录成功！</p>
                    <p>解决: 在<hanla></hanla><code>vue</code>
                      <hanla></hanla>中使用请求拦截器之后使用<hanla></hanla><code>vue-cookie</code>
                      <hanla></hanla>获取<hanla></hanla><code>cookie</code>
                      <hanla></hanla>并设置到请求头
                    </p>
                  </blockquote>
                </li>
              </ul>
            </li>
          </ul>
          <h4 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域<hanla></hanla>
          </h4>
          <h5 id="Spring跨域解决方案"><a href="#Spring跨域解决方案" class="headerlink" title="Spring跨域解决方案"></a>Spring<hanla></hanla>跨域解决方案</h5>
          <ul>
            <li>
              <p><code>SpringBoot</code>
                <hanla></hanla>解决跨域方案
              </p>
              <ul>
                <li>
                  <p><code>@CrossOrigin</code></p>
                </li>
                <li>
                  <p>扩展</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局跨域处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> {</span><br><span class="line">        <span class="comment">// 对那些请求进行跨域处理</span></span><br><span class="line">        registry.addMapping(<span class="string">"/**"</span>)</span><br><span class="line">                .allowCredentials(<span class="literal">false</span>)</span><br><span class="line">                .allowedHeaders(<span class="string">"*"</span>)</span><br><span class="line">                .allowedMethods(<span class="string">"*"</span>)</span><br><span class="line">                .allowedOrigins(<span class="string">"*"</span>)</span><br><span class="line">                .maxAge(<span class="number">3600</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
              </ul>
            </li>
            <li>
              <p><code>CrosFilter</code>： 是<hanla></hanla><code>Spring Web</code>
                <hanla></hanla>中提供的一个处理跨域的过滤器,<hanla></hanla>开发者也可以通过该过滤器处理跨域
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CorsFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCrosFilter</span> {</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    FilterRegistrationBean&lt;CorsFilter&gt; <span class="title function_">cordFilter</span><span class="params">()</span> {</span><br><span class="line">        FilterRegistrationBean&lt;CorsFilter&gt; registrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        corsConfiguration.setAllowedHeaders(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        corsConfiguration.setAllowedMethods(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        corsConfiguration.setAllowedOrigins(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">"/**"</span>, corsConfiguration);</span><br><span class="line">        registrationBean.setFilter(<span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source));</span><br><span class="line">        registrationBean.setOrder(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <blockquote>
                <p>注意: 引入<hanla></hanla><code>Spring Security</code>
                  <hanla></hanla>后<hanla></hanla><code>Spring/SpringBoot</code>
                  <hanla></hanla>中的跨域解决方案会失效。这句话读取后影响了后续的一些判断。
                </p>
              </blockquote>
            </li>
          </ul>
          <h5 id="SpringSecurity跨域解决方案"><a href="#SpringSecurity跨域解决方案" class="headerlink" title="SpringSecurity跨域解决方案"></a>SpringSecurity<hanla></hanla>跨域解决方案</h5>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfigure</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 配置安全</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        ... </span><br><span class="line">        <span class="comment">// 跨域 <span class="doctag">TODO:</span> 这种跨域在后续出现失效,<hanla></hanla>在初次出现这个文档时可以使用,<hanla></hanla>但是当在后续重新写项目的时候采用此种配置时跨域失效了</span></span><br><span class="line">        http.cors().configurationSource(configurationSource());</span><br><span class="line">        ...</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    CorsConfigurationSource <span class="title function_">configurationSource</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        corsConfiguration.setAllowedHeaders(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        corsConfiguration.setAllowedMethods(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        corsConfiguration.setAllowedOrigins(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">"/**"</span>, corsConfiguration);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center">解决跨域<code>【第一次写文档时正常访问】</code></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/1caab0fa30b04585b81c383786fae1ff.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>
          <h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4>
          <ul>
            <li>
              <p>异常处理</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">"root"</span>).password(<span class="string">"{noop}root"</span>).roles(<span class="string">"ADMIN"</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">"lisi"</span>).password(<span class="string">"{noop}lisi"</span>).roles(<span class="string">"USER"</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests().mvcMatchers(<span class="string">"/hello"</span>).hasRole(<span class="string">"ADMIN"</span>).anyRequest().authenticated().and().formLogin().and().csrf().disable();</span><br><span class="line">        <span class="comment">// 认证异常处理</span></span><br><span class="line">        http.exceptionHandling().authenticationEntryPoint((req, resp, ex) -&gt; {</span><br><span class="line">                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                    resp.getWriter().write(<span class="string">"尚未认证,<hanla></hanla>请进行认证操作!"</span>);</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 授权异常处理</span></span><br><span class="line">                .accessDeniedHandler((res, resp, ex) -&gt; {</span><br><span class="line">                    resp.setStatus(HttpStatus.FORBIDDEN.value());</span><br><span class="line">                    resp.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                    resp.getWriter().write(<span class="string">"无权访问!"</span>);</span><br><span class="line">                });</span><br><span class="line">        </span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4>
          <h5 id="权限管理策略"><a href="#权限管理策略" class="headerlink" title="权限管理策略"></a>权限管理策略</h5>
          <ul>
            <li>基于过滤器的权限管理<hanla></hanla>(<code>FilterSecurityInterceptor</code>) <ul>
                <li>基于过滤器的权限管理主要是用来拦截<hanla></hanla><code>HTTP</code>
                  <hanla></hanla>请求，拦截下来之后，根据<hanla></hanla><code>HTTP</code>
                  <hanla></hanla>请求地址进行权限校验
                </li>
              </ul>
            </li>
            <li>基于<hanla></hanla><code>AOP</code>
              <hanla></hanla>的权限管理<hanla></hanla>(<code>MethodSecurityInterceptor</code>)<ul>
                <li>基于<hanla></hanla><code>AOP</code>
                  <hanla></hanla>权限管理主要是用来处理方法级别的权限问题。当需要调用某一个方法时，同过<hanla></hanla><code>AOP</code>
                  <hanla></hanla>将操作拦截下来，然后判断用户受否具备相关的权限。
                </li>
              </ul>
            </li>
          </ul>
          <h5 id="授权-URL-权限管理策略"><a href="#授权-URL-权限管理策略" class="headerlink" title="授权-URL-权限管理策略"></a>授权-URL-权限管理策略</h5>
          <ul>
            <li>
              <p>配置</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="comment">// 创建内存中的数据源</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        <span class="comment">// 角色权限</span></span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">"root"</span>).password(<span class="string">"{noop}root"</span>).roles(<span class="string">"ADMIN"</span>, <span class="string">"USER"</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">"lisi"</span>).password(<span class="string">"{noop}lisi"</span>).roles(<span class="string">"USER"</span>).build());</span><br><span class="line">        <span class="comment">// 权限</span></span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">"wangwu"</span>).password(<span class="string">"{noop}wangwu"</span>).authorities(<span class="string">"READ_INFO"</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 拥有的角色</span></span><br><span class="line">                .mvcMatchers(<span class="string">"/admin"</span>).hasRole(<span class="string">"ADMIN"</span>)</span><br><span class="line">                .mvcMatchers(<span class="string">"/user"</span>).hasRole(<span class="string">"USER"</span>)</span><br><span class="line">                <span class="comment">// 拥有权限</span></span><br><span class="line">                .mvcMatchers(<span class="string">"/info"</span>).hasAuthority(<span class="string">"READ_INFO"</span>)</span><br><span class="line">                .anyRequest().authenticated().and().formLogin().and().csrf().disable();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// mvcMatchers() 匹配多种: /admin /admin/ /admin.html ...</span></span><br><span class="line"><span class="comment">// antMatchers() 只能匹配一种: /admin</span></span><br><span class="line"><span class="comment">// regexMatchers() 支持正则的匹配</span></span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
          </ul>
          <h5 id="基于方法的权限管理"><a href="#基于方法的权限管理" class="headerlink" title="基于方法的权限管理"></a>基于方法的权限管理</h5>
          <ul>
            <li>
              <p>基于方法的权限管理主要是通过<hanla></hanla><code>AOP</code>
                <hanla></hanla>来实现的，<code>Spring Security</code>
                <hanla></hanla>中通过<hanla></hanla><code>MethodSecurityInterceptor</code>
                <hanla></hanla>来提供相关的实现。不同在于<hanla></hanla><code>Filter Security Interceptor</code>
                <hanla></hanla>只是在请求之前进行前置处理，<code>MethodSecurityInterceptor</code>
                <hanla></hanla>除了前置处理之外的还可以进行后置处理。前置处理就是在请求之前判断是否具备相应的权限，后置处理规则是对方法的执行结果进行二次过滤。前置处理和后置处理分别对应了不用的实现类。
              </p>
            </li>
            <li>
              <p><code>@EnableGlobalMethodSecurity</code>
                <hanla></hanla>注解是用来开启权限注解,<hanla></hanla>用法如下
              </p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <ul>
                <li>
                  <p><code>prePostEnabled</code>：开启<hanla></hanla><code>Spring Security</code>
                    <hanla></hanla>提供的四个权限注解
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">@PostAuthorize</span>: 在目标方式执行之后进行权限校验<hanla></hanla></span><br><span class="line"><span class="meta">@PostFilter</span>: 在目标方法执行之后对方法的返回结果进行过滤<hanla></hanla></span><br><span class="line"><span class="meta">@PreAuthorize</span>: 在目标方法执行之前进行权限校验<hanla></hanla></span><br><span class="line"><span class="meta">@PreFilter</span>: 在目标方法执行之前对方法进行过滤</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>securedEnabled</code>: 开启<hanla></hanla><code>Spring Security</code>
                    <hanla></hanla>提供的<hanla></hanla><code>@Secured</code>
                    <hanla></hanla>注解支持、该注解不支持权限表达式
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">@Secured</span>: 访问目标方法必须具有各相应的角色</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p><code>jsr250Enabled</code>: 开启<hanla></hanla><code>JSR-250</code>
                    <hanla></hanla>提供的注解，主要是
                  </p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="meta">@DenyAll</span>: 拒绝所有访问<hanla></hanla></span><br><span class="line"><span class="meta">@PermitAll</span>: 允许所有访问<hanla></hanla></span><br><span class="line"><span class="meta">@RoleAll</span>: 访问目标方法必须具备相应的角色</span><br><span class="line">这些注解同时也不支持权限表达式</span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                  <blockquote>
                    <p>这些基于方法的权限管理相关的注解，一般来说只要设置<hanla></hanla><code>prePostEnabled = true</code>
                      <hanla></hanla>就够用了
                    </p>
                  </blockquote>
                </li>
              </ul>
            </li>
            <li>
              <p>测试</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PostAuthorize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PreFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/hello")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizedController</span> {</span><br><span class="line">    <span class="comment">// and / or</span></span><br><span class="line">    <span class="meta">@PreAuthorize("hasRole('ADMIN') and authentication.name=='root'")</span></span><br><span class="line">    <span class="meta">@GetMapping("/hello1")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello1</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 是否有权限: READ_INFO</span></span><br><span class="line">    <span class="meta">@PreAuthorize("hasAuthority('READ_INFO')")</span></span><br><span class="line">    <span class="meta">@GetMapping("/hello2")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello2</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello READ_INFO"</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 参数必须是认证的用户</span></span><br><span class="line">    <span class="meta">@PreAuthorize("authentication.name==#name")</span></span><br><span class="line">    <span class="meta">@GetMapping("/name")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello: "</span> + name;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * filterTarget 必须是 集合<hanla></hanla>/<hanla></hanla>数组</span></span><br><span class="line"><span class="comment">     * 此接口测试需要在浏览器获取 JSESSIONID 的值，通过认证后访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PreFilter(value = "filterObject.id%2!=0", filterTarget = "users")</span></span><br><span class="line">    <span class="meta">@PostMapping("/users")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUsers</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> List&lt;User&gt; users</span></span><br><span class="line"><span class="params">    )</span> {</span><br><span class="line">        System.out.println(<span class="string">"users= "</span> + users);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostAuthorize("returnObject.id==1")</span></span><br><span class="line">    <span class="meta">@GetMapping("/userId")</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Integer id)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id, <span class="string">"coder-itl"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center">参数必须是<code>认证的用户</code></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/5c4ee82c56624c4395cce4fb66a0c068.png"></td>
                  </tr>
                </tbody>
              </table>
              <table>
                <thead>
                  <tr>
                    <th align="center"><code>userId?id=1</code></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/3b5d47fd482645978d3a5d8635ae4523.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>对结果集处理</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PostFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/hello")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizedController</span> {</span><br><span class="line">    <span class="comment">// 用来对方法的返回值进行过滤</span></span><br><span class="line">    <span class="meta">@PostFilter("filterObject.id%2==0")</span></span><br><span class="line">    <span class="meta">@GetMapping("/lists")</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getAll</span><span class="params">()</span> {</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            users.add(<span class="keyword">new</span> <span class="title class_">User</span>(i, <span class="string">"i: "</span> + i));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>其他测试</p>
              <figure class="highlight java">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.annotation.Secured;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.security.DenyAll;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.security.PermitAll;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.security.RolesAllowed;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/hello")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizedController</span> {</span><br><span class="line">    <span class="comment">// 只能判断角色</span></span><br><span class="line">    <span class="meta">@Secured({"ROLE_USER"})</span></span><br><span class="line">    <span class="meta">@GetMapping("/secured")</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserByUserName</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">99</span>, <span class="string">"coder-itl"</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 具有其中一个即可</span></span><br><span class="line">    <span class="meta">@Secured({"ROLE_ADMIN", "ROLE_USER"})</span></span><br><span class="line">    <span class="meta">@GetMapping("/username")</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserByUsername2</span><span class="params">(String username)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">99</span>, username);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping("/denyAll")</span></span><br><span class="line">    <span class="meta">@DenyAll</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">denyAll</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"DenyAll"</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping("/permitAll")</span></span><br><span class="line">    <span class="meta">@PermitAll</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">permitAll</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"permitAll"</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 具有其中一个角色即可</span></span><br><span class="line">    <span class="meta">@RolesAllowed({"ROLE_ADMIN", "ROLE_USER"})</span></span><br><span class="line">    <span class="meta">@GetMapping("/rolesAllowed")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">rolesAllowed</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"rolesAllowed"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>原理分析</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">授权原理</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/d34d60ffb61f47bfbb88b7a45a5341ad.png"></td>
                  </tr>
                </tbody>
              </table>
              <ul>
                <li><code>ConfigAttribute</code>
                  <hanla></hanla>在<hanla></hanla><code>Spring Security</code>
                  <hanla></hanla>中,<hanla></hanla>用户请求一个资源<hanla></hanla>(通常是一个接口或者一个 <code>Java</code>
                  <hanla></hanla>方法)<hanla></hanla>需要的角色会被封装成一个<hanla></hanla><code>ConfigAttribute</code>
                  <hanla></hanla>对象，在<hanla></hanla><code>ConfigAttribute</code>
                  <hanla></hanla>中只有一个<hanla></hanla><code>getAttribute</code>
                  <hanla></hanla>方法，该方法返回一个<hanla></hanla><code>String</code>
                  <hanla></hanla>字符串，就是角色的名称。一般来说，角色名称都带有一个<hanla></hanla><code>ROLE</code>
                  <hanla></hanla>前缀，投票器<hanla></hanla><code>AccessDecisionVoter</code>
                  <hanla></hanla>所作的事情，其实就是比较用户所具有各的角色和请求某个资源所需的<hanla></hanla><code>ConfigAttribute</code>
                  <hanla></hanla>之间的关系<ul>
                    <li><code>AccesDecisionVoter</code>
                      <hanla></hanla>和<hanla></hanla><code>AccessDecisionManager</code>
                      <hanla></hanla>都有众多的实现类，在<hanla></hanla><code>AccessDecisManager</code>
                      <hanla></hanla>中会挨个遍历<hanla></hanla><code>AccessDecisionVoter</code>，进而决定是否允许用户访问，因而<hanla></hanla><code>AccessDecisionVoter</code>
                      <hanla></hanla>和<hanla></hanla><code>AccessDecisionManager</code>
                      <hanla></hanla>两者的关系类似于<hanla></hanla><code>AuthenticationProvider</code>
                      <hanla></hanla>和<hanla></hanla><code>ProviderManager</code>
                      <hanla></hanla>的关系。
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
          <h5 id="授权实战"><a href="#授权实战" class="headerlink" title="授权实战"></a>授权实战</h5>
          <ul>
            <li>
              <p>创建数据表</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span></span><br><span class="line">(</span><br><span class="line">    id       <span class="type">int</span>(<span class="number">11</span>) comment <span class="string">'用户<hanla></hanla>ID'</span>,</span><br><span class="line">    username <span class="type">varchar</span>(<span class="number">32</span>) comment <span class="string">'用户名'</span>,</span><br><span class="line">    password <span class="type">varchar</span>(<span class="number">255</span>) comment <span class="string">'密码'</span>,</span><br><span class="line">    enabled  tinyint comment <span class="string">'是否启用'</span>,</span><br><span class="line">    locked   tinyint comment <span class="string">'是否锁定'</span></span><br><span class="line">) comment <span class="string">'用户表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_role</span><br><span class="line">(</span><br><span class="line">    id  <span class="type">int</span>(<span class="number">11</span>),</span><br><span class="line">    uid <span class="type">int</span>(<span class="number">11</span>) comment <span class="string">'用户<hanla></hanla>ID'</span>,</span><br><span class="line">    rid <span class="type">int</span>(<span class="number">11</span>) comment <span class="string">'角色<hanla></hanla>ID'</span></span><br><span class="line">) comment <span class="string">'用户角色关系表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> role</span><br><span class="line">(</span><br><span class="line">    id     <span class="type">int</span>(<span class="number">11</span>) comment <span class="string">'角色<hanla></hanla>ID'</span>,</span><br><span class="line">    name   <span class="type">varchar</span>(<span class="number">32</span>) comment <span class="string">'角色名称<hanla></hanla>(英)'</span>,</span><br><span class="line">    nameZh <span class="type">varchar</span>(<span class="number">32</span>) comment <span class="string">'角色名称<hanla></hanla>(中)'</span></span><br><span class="line">) comment <span class="string">'角色表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> menu</span><br><span class="line">(</span><br><span class="line">    id      <span class="type">int</span>(<span class="number">11</span>),</span><br><span class="line">    <span class="keyword">pattern</span> <span class="type">varchar</span>(<span class="number">128</span>)</span><br><span class="line">) comment <span class="string">'菜单表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> menu_role</span><br><span class="line">(</span><br><span class="line">    id  <span class="type">int</span>(<span class="number">11</span>),</span><br><span class="line">    mid <span class="type">int</span>(<span class="number">11</span>),</span><br><span class="line">    rid <span class="type">int</span>(<span class="number">11</span>)</span><br><span class="line">);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
              <table>
                <thead>
                  <tr>
                    <th align="center">逆向关系</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/e0ee1436827e44958a1237c5f446ca61.png"></td>
                  </tr>
                </tbody>
              </table>
            </li>
            <li>
              <p>用户表数据</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'admin'</span>, <span class="string">'{noop}admin'</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">'user'</span>, <span class="string">'{noop}user'</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">'coder-itl'</span>, <span class="string">'{noop}coder-itl'</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>角色表数据</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> role <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'ROLE_ADMIN'</span>,<span class="string">'系统管理员'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> role <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">'ROLE_USER'</span>,<span class="string">'普通用户'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> role <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'ROLE_GUEST'</span>,<span class="string">'游客'</span>);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>菜单表数据</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> menu <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'/admin/**'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> menu <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">'/user/**'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> menu <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'/guest/**'</span>);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>用户角色关系表</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role <span class="keyword">values</span> (<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role <span class="keyword">values</span> (<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role <span class="keyword">values</span> (<span class="number">4</span>,<span class="number">3</span>,<span class="number">3</span>);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>菜单角色数据</p>
              <figure class="highlight sql">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> menu_role <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> menu_role <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> menu_role <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> menu_role <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>);</span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>源文件</p>
              <blockquote>
                <p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gitee.com/coder-itl/security-web-template">https://gitee.com/coder-itl/security-web-template</a></p>
              </blockquote>
            </li>
          </ul>
          <h4 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h4>
          <ul>
            <li>
              <p>前后端权限校验时序图</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">时序图</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/e47732cff3014343808b0f7dcc9f7bcf.jpeg#pic_center"></td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>
          <h4 id="OAuth2"><a href="#OAuth2" class="headerlink" title="OAuth2"></a>OAuth2</h4>
          <h5 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>
            <hanla></hanla>简介
          </h5>
          <ul>
            <li>
              <p>简介</p>
              <div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i>
                <p><code>OAuth2 </code>是一个开放式标准，该标准允许用户让第三方应用访问该用户在某一网站上存储的私密资源<hanla></hanla>(<code>如: 头像、照片、视频等</code>),<hanla></hanla>并且在这个过程中无需将用户名和密码提供给第三方应用。通过令牌<hanla></hanla>(<code>token</code>)<hanla></hanla>可以实现这一功能，每一个令牌授权一个特定的网站在特定的时段内允许可特定的资源。<code>OAtuth</code>
                  <hanla></hanla>让用户可以授权第三方网站灵活访问他们存储在另外一些资源服务器上的特定信息，而非所有的内容。对于用户而言，我们在互联网应用中最常见的<hanla></hanla><code>OAuth</code>
                  <hanla></hanla>应用就是各种第三方登录，例如<hanla></hanla><code>QQ</code>
                  <hanla></hanla>授权登录、微信授权登录、微博授权登录等
                </p>
              </div>
            </li>
          </ul>
          <h5 id="四种授权模式"><a href="#四种授权模式" class="headerlink" title="四种授权模式"></a>四种授权模式</h5>
          <ul>
            <li>
              <p>授权码模式</p>
              <ol>
                <li>授权码模式: 常见的第三方平台登陆都是使用这种模式</li>
                <li>简化模式: 简化模式是不需要第三方服务端参与，直接在浏览器中向授权服务器申请令牌<hanla></hanla>(<code>token</code>)，如果网站是纯静态页面，则可以采用这种方式</li>
                <li>密码模式: 密码模式是用户把用户名<hanla></hanla>/<hanla></hanla>密码直接告诉客户端,<hanla></hanla>客户端使用这些信息后授权服务器申请令牌。这需要用户对客户端高度信任，例如: 客户端应用和服务提供商就是同一家公司。</li>
                <li>客户端模式: 客户端模式是指哭护短使用自己的名义而不是用户的名义向服务提供者申请授权。严格来说，客户端模式并不能算作<hanla></hanla><code>OAuth</code>
                  <hanla></hanla>协议解决问题的一种解决方案，但是对于开发者而言，在一些为移动端提供的授权服务器上
                </li>
              </ol>
            </li>
            <li>
              <p>流程分析</p>
              <table>
                <thead>
                  <tr>
                    <th align="center">流程</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/98584f4cf0384602a4a78fee7f22a2eb.png"></td>
                  </tr>
                </tbody>
              </table>
              <figure class="highlight properties">
                <table>
                  <tbody>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="attr">A</span>: <span class="string">用户打开客户端以后,<hanla></hanla>客户端要求用户给予授权<hanla></hanla></span></span><br><span class="line"><span class="attr">B</span>: <span class="string">用户同意给予客户端授权<hanla></hanla></span></span><br><span class="line"><span class="attr">C</span>: <span class="string">客户端使用上一步获得的授权,<hanla></hanla>向认证服务器申请令牌<hanla></hanla></span></span><br><span class="line"><span class="attr">D</span>: <span class="string">认证服务器对客户端进行认证以后,<hanla></hanla>确认无误，同意发放令牌<hanla></hanla></span></span><br><span class="line"><span class="attr">E</span>: <span class="string">客户端使用令牌，向资源服务器申请获取资源<hanla></hanla></span></span><br><span class="line"><span class="attr">F</span>: <span class="string">资源服务器确认令牌无误,<hanla></hanla>同意向客户端开放资源</span></span><br></pre>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </figure>
            </li>
            <li>
              <p>四种授权模式·</p>
              <ul>
                <li>
                  <p>授权码模式</p>
                  <ul>
                    <li>
                      <p><code>Third-part application</code>： 第三方应用程序,<hanla></hanla>简称<code>客户端<hanla></hanla>(client)</code></p>
                    </li>
                    <li>
                      <p><code>Resource Owner</code>: 资源所有者,<hanla></hanla>简称<code>用户<hanla></hanla>(User)</code></p>
                    </li>
                    <li>
                      <p><code>User Agent</code>: 用户代理,<hanla></hanla>是指<code>浏览器</code></p>
                    </li>
                    <li>
                      <p><code>Authorization Server</code> :<hanla></hanla>认证服务器，即服务端专门用来处理认证的服务器</p>
                    </li>
                    <li>
                      <p><code>Resource Server</code>: 资源服务器,<hanla></hanla>即服务端存放用户生成的资源的服务器。他于认证服务器，可以是同一台服务器。也可以是不同的服务器</p>
                    </li>
                    <li>
                      <p>流程图</p>
                      <table>
                        <thead>
                          <tr>
                            <th align="center">授权码模式流程图</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/5dd9c649610343d39ced106e2aa057cf.png" alt="在这里插入图片描述"></td>
                          </tr>
                        </tbody>
                      </table>
                      <figure class="highlight properties">
                        <table>
                          <tbody>
                            <tr>
                              <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                              </td>
                              <td class="code">
                                <pre><span class="line"><span class="attr">A</span>: <span class="string">用户访问第三方应用,<hanla></hanla>第三方应用通过浏览器导向认证服务器<hanla></hanla></span></span><br><span class="line"><span class="attr">B</span>: <span class="string">用户选择是否给予客户端授权<hanla></hanla></span></span><br><span class="line"><span class="attr">C</span>: <span class="string">假设用户给与授权,<hanla></hanla>认证服务器将用户导向客户端事先指定的`重定向<hanla></hanla>URI`同时附上一个授权码<hanla></hanla></span></span><br><span class="line"><span class="attr">D</span>: <span class="string">客户端收到授权码，附上早先的`重定向 URI`，向认证服务器申请令牌。这一步是在客户端的后台服务器上完成的，对用户不可见<hanla></hanla></span></span><br><span class="line"><span class="attr">E</span>: <span class="string">认证服务器核对授权码和重定向的 URI,<hanla></hanla>确认无误后，向客户端发送访问令牌和更新令牌</span></span><br></pre>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </figure>
                      <table>
                        <thead>
                          <tr>
                            <th align="center">使用第三方应用</th>
                            <th align="center">导向认证服务器</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/6c20ea065f064f8181434889cc00c828.png"></td>
                            <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/8972fa25454d41a996002ea36dd5c625.png"></td>
                          </tr>
                        </tbody>
                      </table>
                    </li>
                    <li>
                      <p>核心参数</p>
                      <table>
                        <thead>
                          <tr>
                            <th>字段</th>
                            <th>描述</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td><code>client_id</code></td>
                            <td>授权服务器注册应用的唯一标识</td>
                          </tr>
                          <tr>
                            <td><code>response_type</code></td>
                            <td>必须<code>固定值</code>在授权码中必须为<hanla></hanla><code>code</code></td>
                          </tr>
                          <tr>
                            <td><code>redirect_uri</code></td>
                            <td>必须<code>通过客户端注册的重定向 URL</code></td>
                          </tr>
                          <tr>
                            <td><code>scope</code></td>
                            <td>必须<code>令牌乐意访问的资源权限 read</code>
                              <hanla></hanla>只读<hanla></hanla><code>all</code>
                              <hanla></hanla>读写
                            </td>
                          </tr>
                          <tr>
                            <td><code>state</code></td>
                            <td>可选<code>存在原样返回客户端，用来防止 CSRF<hanla></hanla>跨站攻击</code></td>
                          </tr>
                        </tbody>
                      </table>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
          <h5 id="OAuth2-标准接口"><a href="#OAuth2-标准接口" class="headerlink" title="OAuth2 标准接口"></a>OAuth2 标准接口</h5>
          <ul>
            <li><code>/oauth/authorize</code>: 授权端点</li>
            <li><code>/oauth/token</code>: 获取令牌端点</li>
            <li><code>/oauth/confirm_access</code>: 用户确认授权提交端点</li>
            <li><code>/oauth/error</code>: 授权服务错误信息端点</li>
            <li><code>/oauth/check_token</code>: 用于资源服务访问的令牌解析端点</li>
            <li><code>/oauth/token_key</code>: 提供共有密钥的端点，如果使用<hanla></hanla><code>JWT</code>
              <hanla></hanla>令牌的话
            </li>
          </ul>
          <h5 id="GITHUB-实战"><a href="#GITHUB-实战" class="headerlink" title="GITHUB 实战"></a>GITHUB 实战</h5>
          <ol>
            <li>
              <p><code>github</code>
                <hanla></hanla>创建<hanla></hanla><code>OAuth</code>
                <hanla></hanla>应用
              </p>
              <blockquote>
                <p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/settings/apps">https://github.com/settings/apps</a></p>
              </blockquote>
            </li>
            <li>
              <p>生成<hanla></hanla><code>ID</code>
                <hanla></hanla>和密钥
              </p>
            </li>
            <li>
              <p>创建项目</p>
              <ul>
                <li>
                  <p>添加依赖</p>
                  <figure class="highlight xml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>创建配置</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 使用 oauth2 认证</span></span><br><span class="line">                .oauth2Login();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>创建控制器</p>
                  <figure class="highlight java">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.user.DefaultOAuth2User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="keyword">public</span> DefaultOAuth2User <span class="title function_">hello</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="keyword">return</span> (DefaultOAuth2User) authentication.getPrincipal();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>配置</p>
                  <figure class="highlight yml">
                    <table>
                      <tbody>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">registration:</span></span><br><span class="line">          <span class="attr">github:</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">677f02f9cd2397d6d443</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">055520c9be8efcd85d8ea089f85f81633a1be92a</span></span><br><span class="line">            <span class="comment"># 一定要与重定向回调 URL 一致</span></span><br><span class="line">            <span class="attr">redirect-uri:</span> <span class="string">http://localhost:8080/login/oauth2/code/github</span> <span class="comment"># /login/oauth2/code/github 固定格式</span></span><br></pre>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </figure>
                </li>
                <li>
                  <p>访问测试</p>
                  <table>
                    <thead>
                      <tr>
                        <th align="center">授权后获取用户信息</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td align="center"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img-blog.csdnimg.cn/9732ab97d8bc45b9a58a6fda29788e95.png"></td>
                      </tr>
                    </tbody>
                  </table>
                </li>
                <li>
                  <p>原理分析</p>
                </li>
              </ul>
            </li>
          </ol>
        </article>
        <div class="post-copyright">
          <div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://coderitl.github.io">coder-itl</a></span></div>
          <div class="post-copyright__type"><span class="post-copyright-meta">
              <hanla></hanla>文章链接:
            </span><span class="post-copyright-info"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.nesxc.com/post/hexocc.html">https://www.nesxc.com/post/hexocc.html</a></span></div>
          <div class="post-copyright__notice"><span class="post-copyright-meta">
              <hanla></hanla>版权声明:
            </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="external nofollow noopener noreferrer">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coderitl.github.io" target="_blank">coder-itl</a>！</span></div>
        </div>
        <div class="tag_share">
          <div class="post-meta__tag-list"></div>
          <div class="post_share">
            <div class="social-share" data-image="https://img-blog.csdnimg.cn/0b5998dfeeb34ef2a9bcb0072018a277.png" data-sites="facebook,twitter,wechat,weibo,qq"></div>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'">
            <script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script>
          </div>
        </div>
        <nav class="pagination-post" id="pagination">
          <div class="prev-post pull-left"><a href="/2022/10/25/48424.html" title="IDEA-模板文件"><img class="cover" src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/coderitl/hiddenContent@v1.10/day321/05.jpg" onerror="onerror=null;src='/null'" alt="cover of previous post">
              <div class="pagination-info">
                <div class="label">上一篇<hanla></hanla>
                </div>
                <div class="prev_info">IDEA-模板文件</div>
              </div>
            </a></div>
          <div class="next-post pull-right"><a href="/2022/10/11/36653.html" title="Oracle VM VirtualBox管理器"><img class="cover" src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/coderitl/hiddenContent@v1.10/day321/32.jpg" onerror="onerror=null;src='/null'" alt="cover of next post">
              <div class="pagination-info">
                <div class="label">下一篇<hanla></hanla>
                </div>
                <div class="next_info">Oracle VM VirtualBox<hanla></hanla>管理器</div>
              </div>
            </a></div>
        </nav>
        <hr>
        <div id="post-comment">
          <div class="comment-head">
            <div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论<hanla></hanla></span></div>
          </div>
          <div class="comment-wrap">
            <div>
              <div id="twikoo-wrap"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="aside-content" id="aside-content">
        <div class="card-widget card-info">
          <div class="is-center">
            <div class="avatar-img"><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://i.328888.xyz/2023/03/19/MJUXa.jpeg" onerror="this.onerror=null;this.src='https://i.328888.xyz/2023/03/20/P3kfC.gif'" alt="avatar"></div>
            <div class="author-info__name">coder-itl</div>
            <div class="author-info__description">To read without reflecting is like eating without digesting.</div>
          </div>
          <div class="card-info-data site-data is-center"><a href="/archives/">
              <div class="headline">
                <hanla></hanla>文章<hanla></hanla>
              </div>
              <div class="length-num">119</div>
            </a><a href="/tags/">
              <div class="headline">
                <hanla></hanla>标签<hanla></hanla>
              </div>
              <div class="length-num">21</div>
            </a><a href="/categories/">
              <div class="headline">
                <hanla></hanla>分类<hanla></hanla>
              </div>
              <div class="length-num">13</div>
            </a></div><a id="card-info-btn" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a>
        </div>
        <div class="card-widget card-announcement">
          <div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>
              <hanla></hanla>公告
            </span></div>
          <div class="announcement_content">本站所有图片来源于网络,<hanla></hanla>侵权请添加管理员删除【3327511395@qq.com】!</div>
        </div>
        <div class="sticky_layout">
          <div class="card-widget" id="card-toc">
            <div class="item-headline"><i class="fas fa-stream"></i><span>
                <hanla></hanla>目录<hanla></hanla>
              </span><span class="toc-percentage"></span></div>
            <div class="toc-content">
              <ol class="toc">
                <li class="toc-item toc-level-3"><a class="toc-link" href="#SpringSecurity"><span class="toc-number">1.</span> <span class="toc-text">SpringSecurity</span></a>
                  <ol class="toc-child">
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%B5%B7%E6%AD%A5%E5%88%9D%E8%AF%86%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.2.</span> <span class="toc-text">创建起步初识项目<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE"><span class="toc-number">1.3.</span> <span class="toc-text">过滤器链<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">认证方式<hanla></hanla></span></a>
                      <ol class="toc-child">
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">1.4.1.</span> <span class="toc-text">认证的概念<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#HTTP%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.2.</span> <span class="toc-text">HTTP<hanla></hanla>基本认证<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#Form%E8%A1%A8%E5%8D%95%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.3.</span> <span class="toc-text">Form<hanla></hanla>表单认证<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#HTTP%E6%91%98%E8%A6%81%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.4.</span> <span class="toc-text">HTTP<hanla></hanla>摘要认证<hanla></hanla></span></a></li>
                      </ol>
                    </li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%A1%B5-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81"><span class="toc-number">1.5.</span> <span class="toc-text">登录页-自定义用户名和密码<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E9%AA%8C%E8%AF%81%E5%8A%9F%E8%83%BD"><span class="toc-number">1.6.</span> <span class="toc-text">关闭验证功能<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%A1%B5-%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.</span> <span class="toc-text">登录页-使用内存中的用户信息<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%92%E8%89%B2-RBAC"><span class="toc-number">1.8.</span> <span class="toc-text">角色- RBAC</span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E7%9A%84%E6%8E%A5%E5%8F%A3%E5%92%8C%E7%B1%BB"><span class="toc-number">1.9.</span> <span class="toc-text">认证的接口和类<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%88%86%E6%9E%90"><span class="toc-number">1.10.</span> <span class="toc-text">自动配置分析<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%BB%98%E8%AE%A4%E7%99%BB%E5%BD%95%E9%A1%B5%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.11.</span> <span class="toc-text">生成默认登录页的流程分析<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81"><span class="toc-number">1.12.</span> <span class="toc-text">自定义认证<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.13.</span> <span class="toc-text">自定义登录页面<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E9%94%80"><span class="toc-number">1.14.</span> <span class="toc-text">注销<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.15.</span> <span class="toc-text">完整配置顺序<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#WebSecurity%E5%92%8CHttpSecurity"><span class="toc-number">1.16.</span> <span class="toc-text">WebSecurity<hanla></hanla>和<hanla></hanla>HttpSecurity</span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E6%BA%90%E8%AE%A4%E8%AF%81-%E4%B8%80"><span class="toc-number">1.17.</span> <span class="toc-text">自定义数据源认证<hanla></hanla>(一)</span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E6%BA%90%E8%AE%A4%E8%AF%81-%E4%BA%8C"><span class="toc-number">1.18.</span> <span class="toc-text">自定义数据源认证<hanla></hanla>(二)</span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F-WEB-%E5%BC%80%E5%8F%91%E8%AE%A4%E8%AF%81%E6%80%BB%E7%BB%93%E6%A1%88%E4%BE%8B"><span class="toc-number">1.19.</span> <span class="toc-text">传统 WEB 开发认证总结案例<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E8%AE%A4%E8%AF%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.20.</span> <span class="toc-text">前后端分离认证总结<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%AE%A4%E8%AF%81%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">1.21.</span> <span class="toc-text">添加认证验证码<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86"><span class="toc-number">1.22.</span> <span class="toc-text">密码加密<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#RemaemberMe"><span class="toc-number">1.23.</span> <span class="toc-text">RemaemberMe</span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%B0%E4%BD%8F%E6%88%91-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.24.</span> <span class="toc-text">自定义记住我<hanla></hanla>(前后端分离实现)</span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.25.</span> <span class="toc-text">会话<hanla></hanla></span></a>
                      <ol class="toc-child">
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">1.25.1.</span> <span class="toc-text">简介<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E5%B9%B6%E5%8F%91%E7%AE%A1%E7%90%86"><span class="toc-number">1.25.2.</span> <span class="toc-text">会话并发管理<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9FWEB%E5%BC%80%E5%8F%91%E5%A4%84%E7%90%86%E5%A4%B1%E6%95%88"><span class="toc-number">1.25.3.</span> <span class="toc-text">传统<hanla></hanla>WEB<hanla></hanla>开发处理失效<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86"><span class="toc-number">1.25.4.</span> <span class="toc-text">前后端分离失效处理<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E5%86%8D%E6%AC%A1%E7%99%BB%E5%BD%95"><span class="toc-number">1.25.5.</span> <span class="toc-text">禁止再次登录<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%BC%9A%E8%AF%9D%E5%85%B1%E4%BA%AB%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.25.6.</span> <span class="toc-text">集群会话共享解决方案<hanla></hanla></span></a></li>
                      </ol>
                    </li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#CSRF-%E6%BC%8F%E6%B4%9E%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.26.</span> <span class="toc-text">CSRF 漏洞保护<hanla></hanla></span></a>
                      <ol class="toc-child">
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-number">1.26.1.</span> <span class="toc-text">简介<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-CSRF-%E9%98%B2%E5%BE%A1"><span class="toc-number">1.26.2.</span> <span class="toc-text">开启 CSRF 防御<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9FWEB%E5%BC%80%E5%8F%91%E4%B8%AD%E4%BD%BF%E7%94%A8CSRF"><span class="toc-number">1.26.3.</span> <span class="toc-text">传统<hanla></hanla>WEB<hanla></hanla>开发中使用<hanla></hanla>CSRF</span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E5%88%86%E7%A6%BB%E4%BD%BF%E7%94%A8-CSRF"><span class="toc-number">1.26.4.</span> <span class="toc-text">前后分离使用 CSRF</span></a></li>
                      </ol>
                    </li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F"><span class="toc-number">1.27.</span> <span class="toc-text">跨域<hanla></hanla></span></a>
                      <ol class="toc-child">
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#Spring%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.27.1.</span> <span class="toc-text">Spring<hanla></hanla>跨域解决方案<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#SpringSecurity%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.27.2.</span> <span class="toc-text">SpringSecurity<hanla></hanla>跨域解决方案<hanla></hanla></span></a></li>
                      </ol>
                    </li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.28.</span> <span class="toc-text">异常处理<hanla></hanla></span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">1.29.</span> <span class="toc-text">授权<hanla></hanla></span></a>
                      <ol class="toc-child">
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number">1.29.1.</span> <span class="toc-text">权限管理策略<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%88%E6%9D%83-URL-%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number">1.29.2.</span> <span class="toc-text">授权-URL-权限管理策略<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%96%B9%E6%B3%95%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">1.29.3.</span> <span class="toc-text">基于方法的权限管理<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E5%AE%9E%E6%88%98"><span class="toc-number">1.29.4.</span> <span class="toc-text">授权实战<hanla></hanla></span></a></li>
                      </ol>
                    </li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#JWT"><span class="toc-number">1.30.</span> <span class="toc-text">JWT</span></a></li>
                    <li class="toc-item toc-level-4"><a class="toc-link" href="#OAuth2"><span class="toc-number">1.31.</span> <span class="toc-text">OAuth2</span></a>
                      <ol class="toc-child">
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-number">1.31.1.</span> <span class="toc-text">简介<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.31.2.</span> <span class="toc-text">四种授权模式<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#OAuth2-%E6%A0%87%E5%87%86%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.31.3.</span> <span class="toc-text">OAuth2 标准接口<hanla></hanla></span></a></li>
                        <li class="toc-item toc-level-5"><a class="toc-link" href="#GITHUB-%E5%AE%9E%E6%88%98"><span class="toc-number">1.31.4.</span> <span class="toc-text">GITHUB 实战</span></a></li>
                      </ol>
                    </li>
                  </ol>
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer id="footer" style="background: transparent">
      <div id="footer-wrap">
        <div class="copyright">©2020 - 2023 By coder-itl</div>
        <div class="framework-info"><span>
            <hanla></hanla>框架
          </span><a target="_blank" rel="external nofollow noopener noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div>
        <div class="footer_custom_text">
          <p><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-orange">&nbsp;<img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/Theme-Buffterfly-blue">&nbsp;<img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/CDN-jsDeliver-blueviolet">&nbsp;<img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/Source-Github-9cf">&nbsp;<img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/Theme-Matery-ff69b4">&nbsp;<img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/Python-Python-success">&nbsp;<img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/Python-Flask-red"></p>
          <p><img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-red?logo=Castorama&amp;logoWidth=18">&nbsp;<img src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?logo=Grunt&amp;logoWidth=18"></p>
        </div>
      </div>
    </footer>
  </div>
  <div id="rightside">
    <div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div>
    <div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div>
  </div>
  <div id="local-search">
    <div class="search-dialog">
      <nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav>
      <div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中<hanla></hanla></span></div>
      <div class="search-wrap">
        <div id="local-search-input">
          <div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div>
        </div>
        <hr>
        <div id="local-search-results"></div>
      </div>
    </div>
    <div id="search-mask"></div>
  </div>
  <div>
    <script src="/js/utils.js"></script>
    <script src="/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script>
    <script src="/js/search/local-search.js"></script>
    <div class="js-pjax">
      <script>
        (() =>
        {
          const init = () =>
          {
            twikoo.init(Object.assign(
            {
              el: '#twikoo-wrap',
              envId: 'https://twikoo-jlw0ln3jv-coderitl.vercel.app/',
              region: 'ap-shanghai',
              onCommentLoaded: function ()
              {
                btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
              }
            }, null))
          }
          const getCount = () =>
          {
            const countELement = document.getElementById('twikoo-count')
            if (!countELement) return
            twikoo.getCommentsCount(
            {
              envId: 'https://twikoo-jlw0ln3jv-coderitl.vercel.app/',
              region: 'ap-shanghai',
              urls: [window.location.pathname],
              includeReply: false
            }).then(function (res)
            {
              countELement.innerText = res[0].count
            }).catch(function (err)
            {
              console.error(err);
            });
          }
          const runFn = () =>
          {
            init()
          }
          const loadTwikoo = () =>
          {
            if (typeof twikoo === 'object')
            {
              setTimeout(runFn, 0)
              return
            }
            getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
          }
          if ('Twikoo' === 'Twikoo' || !false)
          {
            if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
            else loadTwikoo()
          }
          else
          {
            window.loadOtherComment = () =>
            {
              loadTwikoo()
            }
          }
        })()

      </script>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>
    <script defer="" src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
    <script data-pjax="" src="https://cdn.jsdelivr.net/gh/coderitl/FileJsDeliver@v1.1.13/swiper/swiper.min.js"></script>
    <script data-pjax="" src="https://cdn.jsdelivr.net/gh/coderitl/FileJsDeliver@v1.1.13/swiper/swiperindex.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/graingert/wow@1.3.0/dist/wow.min.js"></script>
    <script src="https://www.youxiaohou.com/mactype.user.js"></script>
    <script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script>
    <script>
      let pjaxSelectors = ["head > title", "#config-diff", "#body-wrap", "#rightside-config-hide", "#rightside-config-show", ".js-pjax"]
      var pjax = new Pjax(
      {
        elements: 'a:not([target="_blank"])',
        selectors: pjaxSelectors,
        cacheBust: false,
        analytics: false,
        scrollRestoration: false
      })
      document.addEventListener('pjax:send', function ()
      {
        // removeEventListener scroll 
        window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
        window.scrollCollect && window.removeEventListener('scroll', scrollCollect)
        document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
        if (window.aplayers)
        {
          for (let i = 0; i < window.aplayers.length; i++)
          {
            if (!window.aplayers[i].options.fixed)
            {
              window.aplayers[i].destroy()
            }
          }
        }
        typeof typed === 'object' && typed.destroy()
        //reset readmode
        const $bodyClassList = document.body.classList
        $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
        typeof disqusjs === 'object' && disqusjs.destroy()
      })
      document.addEventListener('pjax:complete', function ()
      {
        window.refreshFn()
        document.querySelectorAll('script[data-pjax]').forEach(item =>
        {
          const newScript = document.createElement('script')
          const content = item.text || item.textContent || item.innerHTML || ""
          Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
          newScript.appendChild(document.createTextNode(content))
          item.parentNode.replaceChild(newScript, item)
        })
        GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()
        typeof chatBtnFn === 'function' && chatBtnFn()
        typeof panguInit === 'function' && panguInit()
        // google analytics
        typeof gtag === 'function' && gtag('config', '',
        {
          'page_path': window.location.pathname
        });
        // baidu analytics
        typeof _hmt === 'object' && _hmt.push(['_trackPageview', window.location.pathname]);
        typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
        // prismjs
        typeof Prism === 'object' && Prism.highlightAll()
      })
      document.addEventListener('pjax:error', (e) =>
      {
        if (e.request.status === 404)
        {
          pjax.loadUrl('/404.html')
        }
      })

    </script>
    <script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  </div><!-- hexo injector body_end start -->
  <script data-pjax="">
    function history_calendar_injector_config()
    {
      var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
      var item_html = '<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span><hanla></hanla>那年今日<hanla></hanla></span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>';
      console.log('已挂载<hanla></hanla>history_calendar')
      // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用<hanla></hanla>(支持<hanla></hanla>pjax<hanla></hanla>跳转)
      parent_div_git.insertAdjacentHTML("afterbegin", item_html) // 有报错，但不影响使用<hanla></hanla>(支持<hanla></hanla>pjax<hanla></hanla>跳转)
    }
    if (document.getElementsByClassName('sticky_layout')[0] & amp; & amp;
      (location.pathname === 'all' || 'all' === 'all'))
    {
      history_calendar_injector_config()
    } < /div>

  </script>
  <script data-pjax="" src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
  <script data-pjax="" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script>
  <script data-pjax="">
    function butterfly_swiper_injector_config()
    {
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/08/13/15497.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/coderitl/Access@v1.0/medias/featureimages/7.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-13</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/08/13/15497.html&quot;);" href="javascript:void(0);" alt=""><hanla></hanla>文件上传下载实战<hanla></hanla></a><div class="blog-slider__text"><hanla></hanla>再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/08/13/15497.html&quot;);" href="javascript:void(0);" alt=""><hanla></hanla>详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/09/04/27324.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/coderitl/Access@v1.0/medias/featureimages/8.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"></a><div class="blog-slider__content"><span class="blog-slider__code">2022-09-04</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/09/04/27324.html&quot;);" href="javascript:void(0);" alt="">Docker<hanla></hanla>安装<hanla></hanla>Oracle</a><div class="blog-slider__text"><hanla></hanla>再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/09/04/27324.html&quot;);" href="javascript:void(0);" alt=""><hanla></hanla>详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/11/30/42622.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://i.328888.xyz/2023/04/01/i2p4AN.jpeg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"></a><div class="blog-slider__content"><span class="blog-slider__code">2022-11-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/11/30/42622.html&quot;);" href="javascript:void(0);" alt="">SpringCloud</a><div class="blog-slider__text"><hanla></hanla>再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/11/30/42622.html&quot;);" href="javascript:void(0);" alt=""><hanla></hanla>详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/12/29/2485.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "https://i.328888.xyz/2023/03/20/P3kfC.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/coderitl/Access@v1.0/medias/featureimages/2.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"></a><div class="blog-slider__content"><span class="blog-slider__code">2022-12-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/12/29/2485.html&quot;);" href="javascript:void(0);" alt="">Ubuntu-系统<hanla></hanla></a><div class="blog-slider__text"><hanla></hanla>再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/12/29/2485.html&quot;);" href="javascript:void(0);" alt=""><hanla></hanla>详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
      console.log('已挂载<hanla></hanla>butterfly_swiper')
      parent_div_git.insertAdjacentHTML("afterbegin", item_html)
    }
    var elist = 'undefined'.split(',');
    var cpage = location.pathname;
    var epage = 'all';
    var flag = 0;
    for (var i = 0; i

  </script>
  <script defer="" src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script>
  <script defer="" data-pjax="" src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script>
  <script data-pjax="" src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script>
  <script data-pjax="">
    function gitcalendar_injector_config()
    {
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin", item_html)
      console.log('已挂载<hanla></hanla>gitcalendar')
    }
    if (document.getElementById('recent-posts') && (location.pathname === '/' || '/' === 'all'))
    {
      gitcalendar_injector_config()
      GitCalendarInit("https://python-github-calenda-4cx5gxbnc-coderitl.vercel.app/api?coderitl", ['#e4dfd7', '#f9f4dc', '#f7e8aa', '#f7e8aa', '#f8df72', '#fcd217', '#fcc515', '#f28e16', '#fb8b05', '#d85916', '#f43e06'], 'coderitl')
    }

  </script>
  <script async="" src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end -->
  <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script>
  <script>
    L2Dwidget.init(
    {
      "pluginModelPath": "assets/",
      "model":
      {
        "jsonPath": "/live2dw/assets/shizuku.model.json"
      },
      "display":
      {
        "position": "left",
        "width": 150,
        "height": 300
      },
      "mobile":
      {
        "show": false
      },
      "rect":
      {
        "opacity": 0.7
      },
      "log": false,
      "pluginJsPath": "lib/",
      "pluginRootPath": "live2dw/",
      "tagMode": false
    });

  </script>



</body></html>